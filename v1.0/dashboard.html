<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard (GHL v1.5)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215;
      --line:#2b2f36; --text:#ffffff; --muted:#c9ced8; --primary:#ed6c03; --primary-dark:#b94f00;
      --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg-main); color:var(--text); margin:0; font-family:var(--font); height:auto; overflow:visible}

    /* Spinner-first */
    body.loading .wrap{display:none;}
    body.loading #loader{display:grid;}
    #loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,17,21,.85); z-index:9999; backdrop-filter:saturate(115%) blur(2px)}
    .spinner{width:88px; height:88px; border-radius:50%; background:radial-gradient(closest-side,rgba(237,108,3,.18),rgba(237,108,3,.04) 55%,transparent 60%);
      position:relative; box-shadow:0 0 60px rgba(237,108,3,.25)}
    .spinner:after{content:""; position:absolute; inset:10px; border-radius:50%; border:6px solid transparent; border-top-color:var(--primary);
      filter:drop-shadow(0 0 8px rgba(237,108,3,.9)); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Layout */
    .wrap{width:100%; max-width:100%; margin:24px auto 80px; padding:0 16px}
    .section-title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .section-title h1{margin:0; font-size:20px; font-weight:800}
    .hint{color:var(--muted); font-size:.92rem}
    .pill{display:inline-flex; gap:8px; align-items:center; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text);
      border-radius:999px; padding:8px 12px; font-weight:700}
    .btn{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
    .btn:hover{background:var(--primary); border-color:var(--primary-dark)}
    .divider{height:1px; background:var(--line); margin:12px 0 18px}

    .controls{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; align-items:center;
      background:var(--bg-panel); border-radius:var(--radius); padding:12px; margin:8px 0 10px}
    .ctrl{grid-column:span 3; display:flex; flex-direction:column; gap:6px; min-width:0; position:relative}
    .ctrl.small{grid-column:span 2}
    .label{color:var(--muted); font-size:.75rem; letter-spacing:.02em; display:flex; align-items:center; gap:6px}
    select{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:600; width:100%}

    /* Color key row */
    .keys{display:flex; flex-wrap:wrap; gap:8px; margin:4px 0 16px}
    .key-pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--bg-panel);
      font-weight:700}
    .dot{width:10px; height:10px; border-radius:50%}

    .grid-kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:8px 0 16px}
    .kpi{background:var(--bg-panel); border-radius:var(--radius); padding:18px; transition:box-shadow .25s, outline .25s; position:relative}
    .kpi h4{margin:0 0 10px; color:var(--muted); font-weight:600; font-size:.95rem; display:flex; align-items:center; gap:6px}
    .kpi .big{font-size:34px; font-weight:800; letter-spacing:.5px}
    .kpi .pillline{margin-top:8px; color:var(--muted)}
    .kpi .pillline strong{color:var(--primary)}
    .kpi.glow{box-shadow:0 0 0 2px var(--primary), 0 0 24px rgba(237,108,3,.35)}

    .card{background:var(--bg-panel); border-radius:var(--radius); padding:14px}
    .section{background:var(--bg-panel); border-radius:var(--radius); padding:14px; margin-top:14px}

    /* Chart titles/subtitles */
    .chart-header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
    .chart-title{font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:8px}
    .chart-sub{color:var(--muted); font-size:.92rem}

    /* Labeled dividers */
    .hr-label{display:flex; align-items:center; gap:10px; margin:14px 0 10px}
    .hr-label .line{flex:1;height:1px;background:var(--line)}
    .hr-label .label{color:var(--muted);font-weight:800;letter-spacing:.2px}

    /* Pipeline table */
    .pipe-row{display:grid; grid-template-columns:1.5fr .6fr 3fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid var(--line)}
    .pipe-row:last-child{border-bottom:none}
    .bar{height:8px; background:var(--bg-panel-2); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; border-radius:999px}

    /* Info bubbles */
    .info-btn{display:inline-grid; place-items:center; width:18px; height:18px; border-radius:999px; border:1px solid var(--line);
      background:transparent; color:var(--muted); cursor:pointer; font-size:12px; line-height:1; padding:0}
    .info-btn:hover{color:#fff;border-color:#444}
    .tip-pop{position:absolute; z-index:999; min-width:220px; max-width:340px; background:var(--bg-panel-2); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; color:var(--muted); box-shadow:var(--shadow); transform:translateY(6px); display:none}
    .tip-pop.show{display:block}
    .tip-pop .title{font-weight:800; color:#fff; margin-bottom:6px}
    .tip-pop .close{position:absolute; right:8px; top:6px; background:transparent; border:0; color:var(--muted); cursor:pointer}

    @media (max-width:980px){
      .grid-kpi{grid-template-columns:1fr 1fr}
      .ctrl{grid-column:span 6}
      .ctrl.small{grid-column:span 6}
    }
    @media (max-width:640px){
      .grid-kpi{grid-template-columns:1fr}
      .ctrl{grid-column:span 12}
      .ctrl.small{grid-column:span 12}
    }
  </style>
</head>
<body class="loading">
<div id="loader"><div class="spinner"></div></div>

<div class="wrap">
  <div class="section-title">
    <div>
      <h1 id="company">—</h1>
      <div class="hint">Last updated on: <span id="last-updated">—</span></div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <div class="pill" id="agent-pill">Agent: <strong id="agent-pill-name">All</strong></div>
      <div class="pill" id="metric-pill">Metric: <strong id="metric-pill-name">Reply %</strong></div>
      <div class="pill" id="range-pill">Range: <strong id="range-pill-name">Last 24 Hours</strong></div>
      <button class="btn" id="refresh-btn">Refresh metrics</button>
    </div>
  </div>

  <div class="divider"></div>

  <div class="controls" id="controls">
    <div class="ctrl small">
      <div class="label">Range</div>
      <select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="ctrl small">
      <div class="label">Metric</div>
      <select id="metric-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Agent</div>
      <select id="agent-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Quick</div>
      <button class="btn" id="show-all">Show All</button>
    </div>
    <div class="ctrl small">
      <div class="label">Chart</div>
      <select id="chart-select">
        <option value="funnel">Funnel</option>
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="donut">Donut</option>
        <option value="line">Line</option>
      </select>
    </div>
  </div>

  <!-- Color keys (agents + range) -->
  <div class="keys" id="keys-row"></div>

  <div class="hr-label"><div class="line"></div><div class="label">Agent performance</div><div class="line"></div></div>

  <div class="grid-kpi">
    <div class="kpi" id="kpi-contacted-card"><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div></div>
    <div class="kpi" id="kpi-replies-card"><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="pillline">Reply %: <strong id="kpi-replyPct">0%</strong></div></div>
    <div class="kpi" id="kpi-leads-card"><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="pillline">Contacted → Appt/Lead %: <strong id="kpi-c2l">0%</strong></div></div>
    <div class="kpi" id="kpi-sold-card"><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="pillline">Appt/Lead → Close %: <strong id="kpi-l2c">0%</strong></div></div>
  </div>

  <div class="card" id="chart-card">
    <div class="chart-header">
      <div class="chart-title" id="main-chart-title">—</div>
      <div class="chart-sub" id="main-chart-sub">—</div>
    </div>
    <div id="main-chart"></div>
  </div>

  <div class="hr-label" style="margin-top:18px"><div class="line"></div><div class="label">Sales pipeline performance</div><div class="line"></div></div>

  <div class="section">
    <div class="section-title" style="margin-bottom:8px">
      <div>
        <h3 id="pipe-title" style="margin:0 0 4px">Sales team pipeline audit info</h3>
        <div class="hint" id="pipe-sub">—</div>
      </div>
      <div style="display:flex; align-items:center; gap:10px">
        <span class="label">View as</span>
        <select id="pipe-view">
          <option value="table">Table</option>
          <option value="bars">Horizontal bars</option>
          <option value="donut">Donut</option>
          <option value="line">Line</option>
        </select>
      </div>
    </div>
    <div id="pipeline-table"></div>
    <div id="pipeline-chart" style="display:none"></div>
    <div class="hint" id="pipe-total" style="margin-top:8px"></div>
  </div>
</div>

<script>
(function(){
  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const fmtInt = n => new Intl.NumberFormat().format(Math.round(Number(n)||0));
  const fmt2 = n => { const v = Number(n)||0; return Math.abs(v - Math.round(v)) < 0.005 ? fmtInt(v) : v.toFixed(2); };
  const safeDiv = (a,b) => (b>0 ? (Number(a)||0)/(Number(b)||0) : 0);
  const pct = (num, den) => 100*safeDiv(num, den);
  const nicePct = v => `${Math.round(Number(v)||0)}%`;
  const LINE = getComputedStyle(document.documentElement).getPropertyValue('--line').trim();
  const rangeLabel = r => ({'24h':'Last 24 Hours','7d':'Last 7 Days','30d':'Last 30 Days','90d':'Last 90 Days'})[r]||r;
  const chartLabel = c => ({'funnel':'Funnel','bar':'Bar (vertical)','bar-h':'Bar (horizontal)','donut':'Donut','line':'Line'})[c]||c;
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  // stable agent palette via hash → index
  const PALETTE = ['#ed6c03','#22c55e','#8b5cf6','#3b82f6','#14b8a6','#ef4444','#eab308','#a855f7'];
  const agentColor = name => { if(!name || name.toLowerCase()==='all') return '#9ca3af'; let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; return PALETTE[h%PALETTE.length]; };

  const RANGE_COLORS = {'24h':'#ed6c03','7d':'#14b8a6','30d':'#3b82f6','90d':'#8b5cf6'};
  const METRIC_ACCENTS = {
    'Reply %':'#ed6c03',
    'Contacted → Appt/Lead %':'#8b5cf6',
    'Appt/Lead → Close %':'#22c55e',
    'Contacted':'#3b82f6',
    'Replies':'#ed6c03',
    'Appointments / Leads':'#8b5cf6',
    'Sold':'#22c55e'
  };

  let DATA = {};
  let mainChart = null, pipeChart = null;
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'funnel', pipeView:'table' };

  const METRICS = [
    { label:'Reply %', key:'Reply %', pct:true },
    { label:'Contacted → Appt/Lead %', key:'Contacted → Appt/Lead %', pct:true },
    { label:'Appt/Lead → Close %', key:'Appt/Lead → Close %', pct:true },
    { label:'Contacted', key:'Contacted' },
    { label:'Replies', key:'Replies' },
    { label:'Appointments / Leads', key:'Appointments / Leads' },
    { label:'Sold', key:'Sold' }
  ];

  const getAgents = () => (DATA.agentsByRange?.[state.range]||[])
    .filter(a => a.agent && a.agent.toLowerCase()!=='cxa')
    .map(a => ({ name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0 }));

  const totalsOf = (arr) => arr.reduce((acc,c)=>{
    Object.keys(c).forEach(k=>{ if(k!=='name') acc[k]=(acc[k]||0)+(Number(c[k])||0); });
    return acc;
  },{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  const addDerived = (o) => ({
    ...o,
    'Reply %': pct(o.Replies, o.Contacted),
    'Contacted → Appt/Lead %': pct(o['Appointments / Leads'], o.Contacted),
    'Appt/Lead → Close %': pct(o.Sold, o['Appointments / Leads'])
  });

  // ===== UI color accents =====
  function setMetricAccent(){
    const color = METRIC_ACCENTS[state.metric] || '#ed6c03';
    const metricPill = $('#metric-pill');
    $('#metric-pill-name').textContent = state.metric;
    metricPill.style.borderColor = color;
    metricPill.style.boxShadow = `0 0 0 2px ${color} inset, 0 0 18px ${hexToRgba(color,.35)}`;

    // KPI glow rules
    ['kpi-contacted-card','kpi-replies-card','kpi-leads-card','kpi-sold-card'].forEach(id=>$('#'+id).classList.remove('glow'));
    if(state.metric==='Contacted') $('#kpi-contacted-card').classList.add('glow');
    if(state.metric==='Replies' || state.metric==='Reply %') { $('#kpi-replies-card').classList.add('glow'); if(state.metric==='Reply %') $('#kpi-contacted-card').classList.add('glow'); }
    if(state.metric==='Appointments / Leads') $('#kpi-leads-card').classList.add('glow');
    if(state.metric==='Contacted → Appt/Lead %') { $('#kpi-contacted-card').classList.add('glow'); $('#kpi-leads-card').classList.add('glow'); }
    if(state.metric==='Appt/Lead → Close %') { $('#kpi-leads-card').classList.add('glow'); $('#kpi-sold-card').classList.add('glow'); }
    if(state.metric==='Sold') $('#kpi-sold-card').classList.add('glow');
  }
  function setRangeAccent(){
    const color = RANGE_COLORS[state.range] || '#6B7280';
    const pill = $('#range-pill');
    $('#range-pill-name').textContent = rangeLabel(state.range);
    pill.style.borderColor = color;
    pill.style.boxShadow = `0 0 0 2px ${color} inset`;
  }
  function setAgentPill(){
    $('#agent-pill-name').textContent = state.agent;
    const pill = $('#agent-pill');
    pill.style.borderColor = state.agent==='All' ? 'var(--line)' : agentColor(state.agent);
    pill.style.boxShadow = state.agent==='All' ? 'none' : `0 0 0 2px ${agentColor(state.agent)} inset`;
  }
  function hexToRgba(hex,a){ const v=hex.replace('#',''); const r=parseInt(v.slice(0,2),16), g=parseInt(v.slice(2,4),16), b=parseInt(v.slice(4,6),16); return `rgba(${r},${g},${b},${a||1})`; }

  // Keys row
  function renderKeys(){
    const el = $('#keys-row');
    const items = [];
    if(state.agent==='All'){
      for(const a of getAgents()){
        items.push(`<span class="key-pill"><span class="dot" style="background:${agentColor(a.name)}"></span>${esc(a.name)}</span>`);
      }
    } else {
      items.push(`<span class="key-pill"><span class="dot" style="background:${agentColor(state.agent)}"></span>${esc(state.agent)}</span>`);
    }
    items.push(`<span class="key-pill"><span class="dot" style="background:${RANGE_COLORS[state.range]||'#6B7280'}"></span>${rangeLabel(state.range)}</span>`);
    el.innerHTML = items.join('');
  }

  // ===== Populate & KPIs =====
  function populateSelectors(){
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    $('#metric-select').value = state.metric;
    const names = ['All', ...getAgents().map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    $('#agent-select').value = state.agent;
    $('#range-select').value = state.range;
    $('#chart-select').value = state.chart;
    $('#pipe-view').value = state.pipeView;

    setMetricAccent(); setRangeAccent(); setAgentPill(); renderKeys();
    attachAllTooltips();  // (re)attach info bubbles
  }

  function renderHeaderKPIs(){
    $('#company').textContent = DATA.company || 'Performance';
    const date = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = date.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

    const base = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent) || {Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
    const d = addDerived(base);
    $('#kpi-contacted').textContent = fmtInt(base.Contacted);
    $('#kpi-replies').textContent = fmtInt(base.Replies);
    $('#kpi-leads').textContent = fmtInt(base['Appointments / Leads']);
    $('#kpi-sold').textContent = fmtInt(base.Sold);
    $('#kpi-replyPct').textContent = nicePct(d['Reply %']);
    $('#kpi-c2l').textContent = nicePct(d['Contacted → Appt/Lead %']);
    $('#kpi-l2c').textContent = nicePct(d['Appt/Lead → Close %']);
  }

  function describeMain(){
    const dot = state.agent==='All' ? '' : `<span class="dot" style="background:${agentColor(state.agent)};width:10px;height:10px;border-radius:999px"></span>`;
    const title = (state.agent==='All') ? `By Agent — ${esc(state.metric)}` : `${dot}${esc(state.agent)} — ${esc(state.metric)}`;
    const sub = `Range: ${rangeLabel(state.range)} · Chart: ${chartLabel(state.chart)}`;
    $('#main-chart-title').innerHTML = title; $('#main-chart-sub').textContent = sub;
  }
  function describePipe(){
    const who = (state.agent==='All') ? 'All agents' : `${esc(state.agent)}`;
    $('#pipe-sub').innerHTML = `Distribution of contact statuses · <span class="dot" style="background:${agentColor(state.agent)};margin-right:6px"></span>${who}`;
  }

  // ===== Charts =====
  function renderMainChart(){
    describeMain();
    const agents = getAgents().map(addDerived);
    const selectedMetric = METRICS.find(m=>m.label===state.metric);

    let cats=[], dataVals=[];
    if(state.agent==='All'){
      cats = agents.map(a=>a.name);
      dataVals = agents.map(a=>Number(a[selectedMetric.key])||0);
    }else{
      const a = agents.find(x=>x.name===state.agent) || null;
      cats = ['Contacted','Replies','Appt/Leads','Sold'];
      dataVals = a ? [a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold].map(v=>Number(v)||0) : [0,0,0,0];
    }

    const isPct = !!selectedMetric?.pct;
    const accent = state.agent==='All' ? (METRIC_ACCENTS[state.metric]||'#ed6c03') : agentColor(state.agent);
    const usableType = (state.chart==='line' && (dataVals.filter(v=>v>0).length<2 || cats.length<2)) ? 'funnel' : state.chart;

    const baseOpts = {
      chart:{ toolbar:{show:false}, parentHeightOffset:0, foreColor:'#c9ced8', dropShadow:{enabled:true, blur:2, opacity:0.18} },
      grid:{borderColor:LINE, strokeDashArray:4}, dataLabels:{enabled:false},
      tooltip:{theme:'dark', y:{formatter:(val)=> isPct ? `${Math.round(Number(val)||0)}%` : fmt2(val)}}, legend:{labels:{colors:'#c9ced8'}},
      xaxis:{ labels:{ style:{colors:'#c9ced8'}, rotate:0, trim:true } },
      yaxis:{ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> isPct ? `${Math.round(v)}%` : fmt2(v) } }
    };

    let opts = {...baseOpts};

    if(usableType==='funnel'){
      // explicit counts axis + step conversion tooltip (prevents NaN%)
      const b = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent)||{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
      const labels = ['Contacted','Replies','Appt/Leads','Sold'];
      const seriesData = [Number(b.Contacted)||0, Number(b.Replies)||0, Number(b['Appointments / Leads'])||0, Number(b.Sold)||0];

      opts.colors=[accent];
      opts.chart.type='bar';
      opts.plotOptions={bar:{horizontal:true, borderRadius:6, barHeight:'40%'}};
      opts.series=[{name:'Count', data:seriesData}];
      opts.yaxis={labels:{style:{colors:'#c9ced8'}}}; // categories, not numbers
      opts.xaxis={labels:{style:{colors:'#c9ced8'}, formatter:(v)=>fmt2(v)}};
      opts.tooltip = {
        theme:'dark',
        custom: ({dataPointIndex}) =>{
          const cur = seriesData[dataPointIndex];
          const prev = seriesData[Math.max(0,dataPointIndex-1)] || cur;
          const step = pct(cur, prev>0?prev:cur);
          return `<div style="padding:8px 10px">
            <div style="font-weight:700">${labels[dataPointIndex]}</div>
            <div>Count: <strong>${fmt2(cur)}</strong> · Step conv: <strong>${nicePct(step)}</strong></div>
          </div>`;
        }
      };
    } else if(usableType==='donut'){
      const sum = dataVals.reduce((a,b)=>a+(Number(b)||0),0);
      let series = dataVals.map(v=>Math.max(0, Number(v)||0));
      let labels = cats.length?cats:[state.metric];
      let colors = (state.agent==='All') ? cats.map(n=>agentColor(n)) : series.map(()=>accent);
      if(sum<=0){ series=[1]; labels=['No data']; colors=['#2b2f36']; }

      opts = {
        ...baseOpts,
        chart:{...baseOpts.chart, type:'donut'},
        series, labels, colors,
        stroke:{show:true, width:0},
        dataLabels:{enabled: sum>0, formatter:(val)=> `${Math.round(val)}%`, style:{fontSize:'12px', fontWeight:700}},
        legend:{position:'right', labels:{colors:'#c9ced8'}},
        fill:{ type:'gradient', gradient:{ shade:'dark', type:'vertical', shadeIntensity:0.5, gradientToColors:colors.map(c=>lighten(c,.15)), opacityFrom:0.95, opacityTo:0.85, stops:[0,50,100]} },
        plotOptions:{ pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label: sum>0?'Total':'No data', formatter:(w)=> sum>0? fmtInt(series.reduce((a,b)=>a+b,0)) : '' } } } } }
      };
    } else if(usableType==='bar-h'){
      const distributed = (state.agent==='All');
      const colors = distributed ? cats.map(n=>agentColor(n)) : [accent];
      opts.colors = colors;
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:true, borderRadius:6, distributed}};
      opts.xaxis={...opts.xaxis, categories:cats};
      opts.series=[{name:state.metric, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else if(usableType==='bar'){
      const distributed = (state.agent==='All');
      const colors = distributed ? cats.map(n=>agentColor(n)) : [accent];
      opts.colors = colors;
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:false, borderRadius:6, columnWidth:'55%', distributed}};
      opts.xaxis={...opts.xaxis, categories:cats};
      opts.series=[{name:state.metric, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else { // line
      opts.colors=[accent];
      opts.chart.type='line'; opts.stroke={curve:'smooth', width:3}; opts.markers={size:3};
      opts.xaxis={...opts.xaxis, categories:cats};
      opts.series=[{name:(state.agent==='All'?state.metric:state.agent), data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    }

    if(mainChart) mainChart.destroy();
    mainChart = new ApexCharts($('#main-chart'), {...opts, chart:{...opts.chart, height:380}});
    mainChart.render();
  }

  function lighten(hex, amt){
    const v = hex.replace('#',''); const r = Math.min(255, parseInt(v.substr(0,2),16)+Math.round(255*amt));
    const g = Math.min(255, parseInt(v.substr(2,2),16)+Math.round(255*amt));
    const b = Math.min(255, parseInt(v.substr(4,2),16)+Math.round(255*amt));
    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
  }

  function getPipeTotals(){
    if(state.agent==='All') return (DATA.auditStatusTotals||[]);
    const agentBlock = (DATA.auditByAgent||[]).find(a=>a.agent===state.agent);
    return agentBlock ? agentBlock.totals || [] : [];
  }

  function renderPipeline(){
    describePipe();
    const rows = getPipeTotals();
    const total = rows.reduce((s,r)=>s+(Number(r.Count)||0),0);
    $('#pipe-title').textContent = `Sales team pipeline audit info${state.agent==='All'?'':` — ${state.agent}`}`;
    $('#pipe-total').textContent = `Total Contacts: ${fmtInt(total)}`;

    const view = state.pipeView;
    $('#pipeline-table').style.display = view==='table'? 'block':'none';
    $('#pipeline-chart').style.display = view==='table'? 'none':'block';

    if(view==='table'){
      const html = rows.map(r=>{
        const count = Number(r.Count)||0;
        const p = pct(count, total);
        const color = agentColor(r.Status);
        return `<div class="pipe-row">
          <div><span class="dot" style="background:${color}"></span>${esc(r.Status)}</div>
          <div style="text-align:right">${fmtInt(count)} (${Math.round(p)}%)</div>
          <div class="bar"><span style="width:${Math.max(0,p)}%; background:${color}"></span></div>
        </div>`;
      }).join('');
      $('#pipeline-table').innerHTML = html || '<div class="hint">No data.</div>';
    } else {
      const series = rows.map(r=>Math.max(0,(Number(r.Count)||0)));
      const labels = rows.map(r=>r.Status);
      const colors = labels.map(l=>agentColor(l));
      const h = Math.min(520, 160 + labels.length*26); // snap container height to content

      const base = { chart:{toolbar:{show:false}, parentHeightOffset:0, foreColor:'#c9ced8', dropShadow:{enabled:true, blur:2, opacity:.18}}, labels, colors, tooltip:{theme:'dark'}, legend:{labels:{colors:'#c9ced8'}} };

      if(view==='bars'){
        const opts = { ...base, chart:{...base.chart, type:'bar'}, plotOptions:{bar:{horizontal:true, borderRadius:6}}, xaxis:{categories:labels}, series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      } else if(view==='donut'){
        const sum = series.reduce((a,b)=>a+b,0);
        const opts = { ...base, chart:{...base.chart, type:'donut'}, series: (sum>0?series:[1]), labels: (sum>0?labels:['No data']), colors: (sum>0?colors:['#2b2f36']), stroke:{show:true, width:0}, dataLabels:{enabled: sum>0, formatter:(v)=>`${Math.round(v)}%`}, plotOptions:{ pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label: sum>0? 'Total':'No data', formatter:(w)=> sum>0? fmtInt(sum) : '' } } } } }, legend:{position:'right', labels:{colors:'#c9ced8'}} };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      } else { // line
        const opts = { ...base, colors:['#ed6c03'], chart:{...base.chart, type:'line'}, stroke:{curve:'smooth', width:3}, markers:{size:3}, xaxis:{categories:labels}, yaxis:{ labels:{ formatter:(v)=>fmt2(v) } }, series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      }
    }
  }

  // ===== Info tooltips =====
  const TIPS = {
    'range': {t:'Range', d:'Time window used to calculate metrics and charts.'},
    'metric': {t:'Metric', d:'What is being measured. Percent metrics are calculated per agent; count metrics show totals.'},
    'agent': {t:'Agent', d:'Filter by a single agent/source. “All” compares agents side by side.'},
    'quick': {t:'Show All', d:'Reset the agent filter back to “All”.'},
    'chart': {t:'Chart', d:'Choose visualization. Funnel shows step counts; Donut shows splits; Bar/Line compare agents.'},
    'kpi_contacted': {t:'Prospects contacted', d:'Outbound contacts (initial touches) within the selected range.'},
    'kpi_replies': {t:'Replies', d:'Inbound replies from prospects. Reply % = Replies ÷ Contacted.'},
    'kpi_leads': {t:'Appointments / Leads', d:'New appointments or leads created. Contacted → Appt/Lead % = Leads ÷ Contacted.'},
    'kpi_sold': {t:'Closed', d:'Units sold / deals closed. Appt/Lead → Close % = Sold ÷ Leads.'},
    'main_chart': {t:'Agent performance chart', d:'Visualizes the chosen metric. If a single agent is selected, shows that agent’s funnel/counts.'},
    'pipeline': {t:'Sales pipeline audit', d:'Contact status distribution for the selected agent (or all agents).'}
  };

  function addTip(el, key){
    if(!el || el.querySelector('.info-btn')) return;
    const info = document.createElement('button');
    info.className='info-btn';
    info.type='button';
    info.setAttribute('aria-label','Info');
    info.textContent='i';

    const pop = document.createElement('div');
    pop.className='tip-pop';
    pop.innerHTML = `<div class="title">${TIPS[key].t}</div><button class="close" aria-label="Close">×</button><div>${TIPS[key].d}</div>`;
    el.style.position = el.style.position || 'relative';
    el.appendChild(info);
    el.appendChild(pop);

    const show = ()=>{ pop.classList.add('show'); };
    const hide = ()=>{ pop.classList.remove('show'); };
    info.addEventListener('mouseenter', show);
    info.addEventListener('focus', show);
    info.addEventListener('click', ()=> pop.classList.toggle('show'));
    el.addEventListener('mouseleave', hide);
    pop.querySelector('.close').addEventListener('click', hide);
  }

  function attachAllTooltips(){
    // Controls
    addTip($('.ctrl:nth-child(1) .label'), 'range');
    addTip($('.ctrl:nth-child(2) .label'), 'metric');
    addTip($('.ctrl:nth-child(3) .label'), 'agent');
    addTip($('.ctrl:nth-child(4) .label'), 'quick');
    addTip($('.ctrl:nth-child(5) .label'), 'chart');

    // KPIs (their <h4>)
    addTip($('#kpi-contacted-card h4'), 'kpi_contacted');
    addTip($('#kpi-replies-card h4'), 'kpi_replies');
    addTip($('#kpi-leads-card h4'), 'kpi_leads');
    addTip($('#kpi-sold-card h4'), 'kpi_sold');

    // Main chart title + Pipeline title
    addTip($('#main-chart-title'), 'main_chart');
    addTip($('#pipe-title'), 'pipeline');
  }

  // ===== infra =====
  const showLoader = (flag)=>{ document.body.classList.toggle('loading', !!flag); };

  function wire(){
    $('#range-select').addEventListener('change', e=>{ state.range=e.target.value; setRangeAccent(); renderKeys(); refreshAll(); });
    $('#metric-select').addEventListener('change', e=>{ state.metric=e.target.value; setMetricAccent(); refreshChartsOnly(); });
    $('#agent-select').addEventListener('change', e=>{ state.agent=e.target.value; setAgentPill(); renderKeys(); refreshAll(); });
    $('#chart-select').addEventListener('change', e=>{ state.chart=e.target.value; renderMainChart(); sendHeight(); });
    $('#pipe-view').addEventListener('change', e=>{ state.pipeView=e.target.value; renderPipeline(); sendHeight(); });
    $('#show-all').addEventListener('click', ()=>{ state.agent='All'; $('#agent-select').value='All'; setAgentPill(); renderKeys(); refreshAll(); });
    $('#refresh-btn').addEventListener('click', ()=> window.location.reload());
    window.addEventListener('resize', ()=> sendHeight());
    window.addEventListener('message', (e)=>{ const m=e?.data; if(!m) return; if(m.type==='VQ_METRICS'){ renderDashboard(m.payload); } if(m.type==='VQ_REQUEST_HEIGHT'){ sendHeight(); }});
  }

  function refreshAll(){ renderHeaderKPIs(); renderMainChart(); renderPipeline(); sendHeight(); }
  function refreshChartsOnly(){ renderMainChart(); renderPipeline(); sendHeight(); }

  function computedHeight(){
    return Math.max(
      document.body.scrollHeight, document.documentElement.scrollHeight,
      document.body.offsetHeight, document.documentElement.offsetHeight,
      document.body.clientHeight, document.documentElement.clientHeight
    );
  }
  function sendHeight(){ setTimeout(()=>{ parent.postMessage({type:'VQ_IFR_HEIGHT', height: computedHeight() }, '*'); }, 0); }
  const ro = new ResizeObserver(()=> sendHeight()); ro.observe(document.documentElement);

  // public entry
  window.renderDashboard = function(payload){
    try{
      showLoader(true);
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      state.range = '24h'; state.chart = 'funnel'; state.metric = state.metric || 'Reply %'; state.agent = 'All';
      populateSelectors(); refreshAll();
    }catch(err){ console.error('renderDashboard failed', err); }
    finally{ showLoader(false); }
  };

  document.addEventListener('DOMContentLoaded', ()=>{ populateSelectors(); wire(); sendHeight(); });
})();
</script>
</body>
</html>
