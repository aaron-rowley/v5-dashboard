<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agent Performance Dashboard (v1.1)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    /* keep your existing vars/styles, cut audit + contacts */
    :root { --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215;
      --line:#2b2f36; --text-main:#ffffff; --text-muted:#a9b0bc; --primary:#ed6c03; --primary-dark:#b94f00;
      --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25);}
    html,body{background:var(--bg-main);margin:0;font-family:var(--font);color:var(--text-main)}
    #wrapper{max-width:1200px;margin:40px auto;padding:0 20px}
    .controls{display:flex;flex-wrap:wrap;gap:16px;align-items:center;margin:0 0 24px;padding:16px;background:var(--bg-panel);border-radius:var(--radius)}
    .controls .label{color:var(--text-muted);font-weight:500;font-size:.9rem}
    .chart-container{background:var(--bg-panel);border-radius:var(--radius);padding:20px}
    .grid-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px}
    .panel{background:var(--bg-panel);border-radius:var(--radius);padding:24px}
    .panel-title{font-size:1.25rem;font-weight:600;margin:0 0 20px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}
    .kpi{background:var(--bg-panel);border-radius:var(--radius);padding:20px}
    .kpi h4{margin:0 0 8px;font-weight:500;color:var(--text-muted)}
    .kpi .big{font-size:36px;font-weight:700;margin-bottom:12px}
    .kpi .pill{display:inline-block;font-size:.85rem;font-weight:500}
    .kpi .pill strong{color:var(--primary)}
  </style>
</head>
<body>
<div id="wrapper">
  <div class="header">
    <h1 class="title" id="biz-name">—</h1>
    <p class="sub">Agent Performance Intelligence Suite</p>
    <div class="flow-label">Prospects Contacted → Replies → Appts / Leads → Closed</div>
    <div class="last-updated-bar">
      <span>Last updated on: <strong id="last-updated">—</strong></span>
      <button class="btn-refresh" id="refresh">Refresh metrics</button>
    </div>
  </div>

  <!-- controls first -->
  <div class="controls">
    <span class="label">Range:</span>
    <select id="range-select"></select>
    <span class="label">Metric:</span>
    <select id="metric-select"></select>
    <span class="label">Agent:</span>
    <select id="agent-select"></select>
    <span class="label">Chart:</span>
    <select id="chart-type-select">
      <option value="bar">Bar (vertical)</option>
      <option value="bar-h">Bar (horizontal)</option>
      <option value="line">Line</option>
      <option value="donut">Donut</option>
    </select>
    <button id="show-all-btn">Show All</button>
  </div>

  <!-- KPIs -->
  <div class="kpis" id="kpis-grid"></div>

  <!-- Chart -->
  <div class="chart-container" id="main-chart-container"></div>

  <!-- Two panels -->
  <div class="grid-layout">
    <div class="panel" id="all-agents-card"></div>
    <div class="panel" id="pipeline-status-panel"></div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const fmt=n=>new Intl.NumberFormat().format(Math.round(n||0));
  const pct=(num,den)=>den>0?(100*num/den):0;
  const nicePct=v=>`${parseFloat(v||0).toFixed(1)}%`;

  let DATA={};
  const state={range:'24h',metric:'Reply %',agentType:'All',chartType:'bar'};

  const METRICS=[
    {label:'Reply %',key:'Reply %',isPct:true,formula:(a)=>`${a.Replies}/${a.Contacted}`},
    {label:'Contacted → Appt/Lead %',key:'Contacted → Appt/Lead %',isPct:true,formula:(a)=>`${a['Appointments / Leads']}/${a.Contacted}`},
    {label:'Appt/Lead → Close %',key:'Appt/Lead → Close %',isPct:true,formula:(a)=>`${a.Sold}/${a['Appointments / Leads']}`},
    {label:'Contacted → Close %',key:'Contacted → Close %',isPct:true,formula:(a)=>`${a.Sold}/${a.Contacted}`}
  ];

  const getAgentData=(range)=>{
    return (DATA.agentsByRange?.[range]||[]).map(a=>({
      name:a.agent,
      Contacted:a.outbound||0,
      Replies:a.inbound||0,
      'Appointments / Leads':a.leads||0,
      Sold:a.sold||0
    }));
  };

  const computeMetrics=(d)=>({...d,
    'Reply %':pct(d.Replies,d.Contacted),
    'Contacted → Appt/Lead %':pct(d['Appointments / Leads'],d.Contacted),
    'Appt/Lead → Close %':pct(d.Sold,d['Appointments / Leads']),
    'Contacted → Close %':pct(d.Sold,d.Contacted)
  });

  function renderKPIs(){
    const d=DATA.byRange?.[state.range]||{};
    const contacted=d.messages?.outbound||0,
          replies=d.messages?.inbound||0,
          leads=d.leads||0,
          sold=d.sold||0;
    const kpiData=[
      {title:'Prospects contacted',big:fmt(contacted)},
      {title:'Replies',big:fmt(replies),pill:`Reply %: <strong>${nicePct(pct(replies,contacted))}</strong>`},
      {title:'Appointments / Leads',big:fmt(leads),pill:`Contacted → Appt/Lead %: <strong>${nicePct(pct(leads,contacted))}</strong>`},
      {title:'Closed',big:fmt(sold),pill:`Appt/Lead → Close %: <strong>${nicePct(pct(sold,leads))}</strong>`}
    ];
    $('#kpis-grid').innerHTML=kpiData.map(k=>`
      <div class="kpi"><h4>${k.title}</h4><div class="big">${k.big}</div>${k.pill?`<div class="pill">${k.pill}</div>`:''}</div>`).join('');
  }

  function renderMainChart(){
    const agents=getAgentData(state.range).map(computeMetrics);
    const metric=METRICS.find(m=>m.label===state.metric)||METRICS[0];
    let categories=[],seriesData=[];

    if(state.agentType==='All'){
      categories=agents.map(a=>a.name);
      seriesData=[{name:metric.label,data:agents.map(a=>a[metric.key]||0)}];
    }else{
      const a=agents.find(x=>x.name===state.agentType);
      if(a){categories=['Contacted','Replies','Appts/Leads','Sold'];
        seriesData=[{name:a.name,data:[a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold]}];
      }
    }

    const type=state.chartType==='donut'?'donut':(state.chartType==='line'?'line':'bar');

    const options={
      series:seriesData,
      chart:{type,height:350,toolbar:{show:false}},
      labels:categories,
      plotOptions:{bar:{horizontal:state.chartType==='bar-h',borderRadius:6,columnWidth:'55%'}},
      tooltip:{theme:'dark',y:{formatter:(val,opts)=>{
        const i=opts.dataPointIndex;
        const a=agents[i];
        if(metric.isPct && a){
          return `${nicePct(val)} (${metric.formula(a)})`;
        }
        return fmt(val);
      }}}
    };

    if(window.mainChart)window.mainChart.destroy();
    window.mainChart=new ApexCharts($('#main-chart-container'),options);
    window.mainChart.render();
  }

  function renderAllAgentsCard(){
    let agents=getAgentData(state.range);
    if(state.agentType!=='All'){agents=agents.filter(a=>a.name===state.agentType);}
    const totals=agents.reduce((acc,c)=>{for(const k in c){if(k!=='name')acc[k]=(acc[k]||0)+c[k];}return acc;},{});
    const t=computeMetrics(totals);
    $('#all-agents-card').innerHTML=`
      <h3 class="panel-title">${state.agentType==='All'?'All Agents*':state.agentType}</h3>
      <div class="stat-row"><span>Contacted</span><span>${fmt(t.Contacted)}</span></div>
      <div class="stat-row"><span>Replies</span><span>${fmt(t.Replies)}</span></div>
      <div class="stat-row"><span>Appts/Leads</span><span>${fmt(t['Appointments / Leads'])}</span></div>
      <div class="stat-row"><span>Sold</span><span>${fmt(t.Sold)}</span></div>`;
  }

  function renderPipelineStatus(){
    const statuses=DATA.auditStatusTotals||[];
    const total=statuses.reduce((s,x)=>s+x.Count,0);
    $('#pipeline-status-panel').innerHTML=`
      <h3 class="panel-title">Pipeline Status</h3>
      ${statuses.map(s=>`
        <div class="stat-row"><span>${s.Status}</span>
          <span>${fmt(s.Count)} (${nicePct(pct(s.Count,total))})</span>
        </div>`).join('')}
      <div class="stat-row"><span>Total</span><span>${fmt(total)}</span></div>`;
  }

  function renderAll(){
    renderKPIs();renderMainChart();renderAllAgentsCard();renderPipelineStatus();
  }

  window.renderDashboard=function(payload){
    DATA=(typeof payload==='string')?JSON.parse(payload):payload;
    renderAll();
  };

  document.addEventListener('DOMContentLoaded',()=>{
    renderAll();
    document.getElementById('range-select').innerHTML=`<option value="24h">24h</option><option value="7d">7d</option><option value="30d">30d</option><option value="90d">90d</option>`;
    document.getElementById('metric-select').innerHTML=METRICS.map(m=>`<option>${m.label}</option>`).join('');
    document.getElementById('agent-select').innerHTML=`<option>All</option>`;
    ['range','metric','agent','chart-type'].forEach(id=>{
      document.getElementById(id+'-select').addEventListener('change',e=>{
        state[id.replace('-select','')]=e.target.value;
        renderAll();
      });
    });
  });
})();
</script>
</body>
</html>
