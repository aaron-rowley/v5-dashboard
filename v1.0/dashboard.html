<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard (v1.1)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115;--bg-panel:#17191e;--bg-panel-2:#21242b;--bg-element:#101215;
      --line:#2b2f36;--text-main:#f4f6fb;--text-muted:#b8bfca;--primary:#ed6c03;--primary-dark:#b94f00;
      --accent-1:#3b82f6;--accent-2:#10b981;--accent-3:#f59e0b;--accent-4:#ef4444;
      --radius:12px;--font:'Outfit',sans-serif;--shadow:0 8px 32px rgba(0,0,0,.25)
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{background:var(--bg-main);margin:0;font-family:var(--font);color:var(--text-main)}
    /* Let the iframe grow — no internal scrollbars */
    html,body{height:auto;overflow:visible}

    #wrapper{max-width:1200px;margin:28px auto;padding:0 20px}
    .header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-size:24px;font-weight:700;margin:0}
    .updated{color:var(--text-muted);font-size:.9rem}
    .pill{background:var(--bg-panel-2);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:600}

    .toolbar{margin:14px 0 18px;background:var(--bg-panel);border-radius:var(--radius);padding:12px;display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:10px}
    .ctrl{display:flex;flex-direction:column;gap:6px}
    .label{color:var(--text-muted);font-size:.8rem;font-weight:600}
    select,button{appearance:none;background:var(--bg-panel-2);border:1px solid var(--line);color:var(--text-main);border-radius:10px;padding:10px 12px;font-size:.92rem}
    .btn{cursor:pointer;font-weight:600}
    .btn:hover{background:var(--primary);border-color:var(--primary-dark)}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .kpi{background:var(--bg-panel);border-radius:var(--radius);padding:18px}
    .kpi h4{margin:0 0 8px;color:var(--text-muted);font-size:.95rem;font-weight:600}
    .big{font-size:32px;font-weight:800}
    .subpill{margin-top:6px;color:var(--text-muted);font-size:.9rem}
    .subpill strong{color:var(--primary)}

    .panel{background:var(--bg-panel);border-radius:var(--radius);padding:20px;margin-top:16px}
    .panel-title{margin:0 0 12px;font-weight:700}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}

    /* Pipeline list bars */
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--line)}
    .row:last-child{border-bottom:none}
    .row .bar{height:8px;background:var(--bg-panel-2);border-radius:4px;flex:1;margin:0 10px;overflow:hidden}
    .row .bar > span{display:block;height:100%;background:var(--accent-1)}

    /* Full-screen loading spinner */
    .loading-cover{position:fixed;inset:0;background:rgba(15,17,21,.9);display:none;align-items:center;justify-content:center;z-index:9999}
    .spinner{width:84px;height:84px;border-radius:50%;border:6px solid rgba(237,108,3,.18);border-top-color:var(--primary);box-shadow:0 0 24px rgba(237,108,3,.45), inset 0 0 18px rgba(237,108,3,.35);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:980px){
      .kpis{grid-template-columns:1fr 1fr}
      .two-col{grid-template-columns:1fr}
      .toolbar{grid-template-columns:1fr 1fr;gap:12px}
    }
  </style>
</head>
<body>
<div id="wrapper">
  <div class="header">
    <h1 class="title" id="biz-name">—</h1>
    <span class="pill" id="agent-pill" style="display:none"></span>
    <span class="updated" id="last-updated">Last updated: —</span>
    <button class="btn" id="refresh" style="margin-left:auto">Refresh metrics</button>
  </div>

  <div class="toolbar" id="toolbar">
    <div class="ctrl"><span class="label">Range</span>
      <select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="ctrl"><span class="label">Metric</span>
      <select id="metric-select"></select>
    </div>
    <div class="ctrl"><span class="label">Agent</span>
      <select id="agent-select"></select>
    </div>
    <div class="ctrl"><span class="label">Quick</span>
      <button id="show-all-btn" class="btn">Show All</button>
    </div>
    <div class="ctrl"><span class="label">Chart</span>
      <select id="chart-type-select">
        <option value="funnel">Funnel</option>
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="donut">Donut</option>
        <option value="line">Line</option>
      </select>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi"><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div><div class="subpill" id="kpi-1"></div></div>
    <div class="kpi"><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="subpill">Reply %: <strong id="kpi-reply-pct">0.0%</strong></div></div>
    <div class="kpi"><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="subpill">Contacted → Appt/Lead %: <strong id="kpi-cta-pct">0.0%</strong></div></div>
    <div class="kpi"><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="subpill">Appt/Lead → Close %: <strong id="kpi-close-pct">0.0%</strong></div></div>
  </div>

  <div class="panel">
    <div id="main-chart" style="min-height:360px"></div>
  </div>

  <div class="panel">
    <h3 class="panel-title" id="pipe-title">Pipeline Status</h3>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
      <span class="label">View as</span>
      <select id="pipe-view" style="width:180px">
        <option value="bars">Horizontal bars</option>
        <option value="donut">Donut</option>
      </select>
    </div>
    <div id="pipeline-chart" style="min-height:320px"></div>
    <div id="pipeline-list"></div>
  </div>
</div>

<!-- Loading overlay -->
<div class="loading-cover" id="loading">
  <div class="spinner"></div>
</div>

<script>
(function(){
  // ------- helpers
  const $ = s => document.querySelector(s);
  const fmt = n => new Intl.NumberFormat().format(Math.round(n||0));
  const pct = (a,b) => b>0 ? (100*a/b) : 0;
  const nicePct = v => `${parseFloat(v||0).toFixed(1)}%`;
  const VAR={primary:getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(), line:getComputedStyle(document.documentElement).getPropertyValue('--line').trim(), muted:getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()};

  // ------- state
  let DATA={};
  const state={range:'24h', metric:'Reply %', agentType:'All', chartType:'funnel'};
  let chart=null, pipeChart=null;

  const METRICS=[
    {label:'Reply %',key:'Reply %',isPct:true, tip:(a)=>`Reply % = Replies / Contacted`},
    {label:'Contacted → Appt/Lead %',key:'Contacted → Appt/Lead %',isPct:true, tip:()=>`Appt/Lead % = Leads / Contacted`},
    {label:'Appt/Lead → Close %',key:'Appt/Lead → Close %',isPct:true, tip:()=>`Close % = Sold / Leads`},
    {label:'Contacted',key:'Contacted',isPct:false},
    {label:'Replies',key:'Replies',isPct:false},
    {label:'Appointments / Leads',key:'Appointments / Leads',isPct:false},
    {label:'Sold',key:'Sold',isPct:false}
  ];
  const PIPELINE_COLORS={
    'New':'#ED6C03','Lost':'#EF4444','Sold':'#22C55E','Needs Follow Up':'#F59E0B','Pipeline':'#8B5CF6','Service':'#60A5FA','Unchecked':'#9CA3AF','Bad Lead':'#A78BFA','default':'#6B7280'
  };

  // ------- data transforms
  const getAgentRows = (range) => (DATA.agentsByRange?.[range]||[]).filter(a=>a.agent && a.agent.toLowerCase()!=='cxa').map(a=>({
    name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0
  }));
  const withMetrics = o => ({
    ...o,
    'Reply %': pct(o.Replies,o.Contacted),
    'Contacted → Appt/Lead %': pct(o['Appointments / Leads'], o.Contacted),
    'Appt/Lead → Close %': pct(o.Sold, o['Appointments / Leads'])
  });
  const aggregate = rows => rows.reduce((acc,r)=>{['Contacted','Replies','Appointments / Leads','Sold'].forEach(k=>acc[k]=(acc[k]||0)+(r[k]||0));return acc;},{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  // ------- UI setup
  function populateSelectors(){
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    const names=['All',...getAgentRows(state.range).map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
    $('#chart-type-select').value = state.chartType;
  }

  function renderHeader(){
    $('#biz-name').textContent = DATA.company || '—';
    const d = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = `Last updated on: ${d.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'})}`;
    $('#agent-pill').style.display = state.agentType==='All' ? 'none' : 'inline-flex';
    if(state.agentType!=='All') $('#agent-pill').textContent = `Agent: ${state.agentType}`;
  }

  function renderKPIs(){
    const r = DATA.byRange?.[state.range] || {}; const contacted=r.messages?.outbound||0; const replies=r.messages?.inbound||0; const leads=r.leads||0; const sold=r.sold||0;
    $('#kpi-contacted').textContent = fmt(contacted);
    $('#kpi-replies').textContent = fmt(replies);
    $('#kpi-leads').textContent = fmt(leads);
    $('#kpi-sold').textContent = fmt(sold);
    $('#kpi-reply-pct').textContent = nicePct(pct(replies,contacted));
    $('#kpi-cta-pct').textContent = nicePct(pct(leads,contacted));
    $('#kpi-close-pct').textContent = nicePct(pct(sold,leads));
  }

  // ------- main chart
  function renderChart(){
    const rows = getAgentRows(state.range).map(withMetrics);
    const metric = METRICS.find(m=>m.label===state.metric) || METRICS[0];

    let categories=[], series=[];
    let type = state.chartType;

    // When only one category available, avoid a flat line
    const hasMany = rows.length>1;
    if(type==='line' && !hasMany) type='funnel';

    if(state.agentType==='All'){
      categories = rows.map(r=>r.name);
      if(type==='funnel'){
        const steps=['Contacted','Replies','Appointments / Leads','Sold'];
        series = steps.map((step,idx)=>({name:step, data: rows.map(r=> r[step]||0)}));
      }else{
        series=[{name:metric.label, data: rows.map(r=> r[metric.key]||0)}];
      }
    } else {
      const r = rows.find(x=>x.name===state.agentType) || withMetrics({Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
      if(type==='funnel'){
        categories=['Contacted','Replies','ApptLeads','Sold'];
        series=[{ name:'Funnel', data:[r.Contacted,r.Replies,r['Appointments / Leads'],r.Sold] }];
      } else {
        categories=['Contacted','Replies','ApptLeads','Sold'];
        series=[{ name: state.agentType, data:[r.Contacted,r.Replies,r['Appointments / Leads'],r.Sold] }];
      }
    }

    // Build options
    const opts={
      series:series,
      chart:{ type:(type==='line'?'line':'bar'), height:380, toolbar:{show:false}, parentHeightOffset:0 },
      plotOptions:{ bar:{ horizontal:(type==='bar-h' || type==='funnel'), borderRadius:6, columnWidth:(type==='funnel'?'75%':'55%') } },
      dataLabels:{ enabled:false }, stroke:{ curve:'smooth', width:3 },
      colors:[VAR.primary,'#22c55e','#fbbf24','#ef4444'],
      grid:{ borderColor:VAR.line, strokeDashArray:4 },
      xaxis:{ categories:categories, labels:{style:{colors:VAR.muted}} },
      yaxis:{ labels:{ style:{colors:VAR.muted}, formatter:v=> metric.isPct? `${Math.round(v)}%` : fmt(v)} },
      tooltip:{ theme:'dark', y:{ formatter:(v,ctx)=>{
        if(type==='funnel'){
          const label = ctx.seriesIndex===0? 'Contacted' : ctx.seriesIndex===1? 'Replies' : ctx.seriesIndex===2? 'Appt/Leads' : 'Sold';
          // compute step % against Contacted when possible
          let denom = 0, num=v;
          if(state.agentType==='All'){
            const i = ctx.dataPointIndex; const base = series[0].data[i]||0; denom=base; // Contacted column for that agent
          }else{
            denom = series[0].data[0]||0; // Contacted value for single agent funnel
          }
          const stepPct = pct(num, denom);
          return `${fmt(num)}  — step conv ${nicePct(stepPct)}`;
        }
        if(metric.isPct){
          let num=0,den=1; const cat= ctx.w.globals.labels[ctx.dataPointIndex];
          if(state.agentType==='All'){
            // reconstruct from rows
            const r = getAgentRows(state.range).map(withMetrics)[ctx.dataPointIndex]||{};
            if(metric.key==='Reply %'){num=r.Replies;den=r.Contacted}
            else if(metric.key==='Contacted → Appt/Lead %'){num=r['Appointments / Leads'];den=r.Contacted}
            else if(metric.key==='Appt/Lead → Close %'){num=r.Sold;den=r['Appointments / Leads']}
          } else {
            const r = getAgentRows(state.range).find(x=>x.name===state.agentType) || {};
            if(cat==='Contacted'){num=r.Replies;den=r.Contacted}
          }
          return `${nicePct(v)} — ${fmt(num)} / ${fmt(den)}`;
        }
        return fmt(v);
      }}}
    };

    if(chart) chart.destroy();
    chart = new ApexCharts($('#main-chart'), opts); chart.render().then(sendHeight);
  }

  // ------- pipeline section
  function renderPipeline(){
    const titleAgent = state.agentType==='All' ? 'All Agents*' : state.agentType;
    $('#pipe-title').textContent = `Pipeline Status — ${titleAgent}`;

    const statuses = DATA.auditStatusTotals || [];
    const total = statuses.reduce((s,x)=> s + (x.Count||0), 0) || 0;
    const labels = statuses.map(s=>s.Status);
    const values = statuses.map(s=>s.Count||0);
    const colors = labels.map(l=> PIPELINE_COLORS[l] || PIPELINE_COLORS.default);

    const view = $('#pipe-view').value;

    if(pipeChart) { pipeChart.destroy(); pipeChart=null; }

    const common={ chart:{ toolbar:{show:false}, height:320, parentHeightOffset:0 }, labels, colors, tooltip:{theme:'dark', y:{formatter:(v,i)=>`${fmt(v)} (${nicePct(pct(v,total))})`}} };

    if(view==='donut'){
      pipeChart = new ApexCharts($('#pipeline-chart'), { ...common, series:values, chart:{...common.chart, type:'donut'}, legend:{labels:{colors:VAR.muted}} });
    }else{
      pipeChart = new ApexCharts($('#pipeline-chart'), { ...common, series:[{name:'Count', data:values}], chart:{...common.chart, type:'bar'}, plotOptions:{bar:{horizontal:true,borderRadius:6,barHeight:'60%'}}, xaxis:{labels:{style:{colors:VAR.muted}}}, grid:{borderColor:VAR.line,strokeDashArray:4} });
    }
    pipeChart.render();

    // list view under chart
    $('#pipeline-list').innerHTML = statuses.map(s=>{
      const p = total? pct(s.Count,total):0; const w = Math.max(2, Math.round(p));
      return `<div class="row"><span>${s.Status}</span><div class="bar"><span style="width:${w}%;background:${PIPELINE_COLORS[s.Status]||PIPELINE_COLORS.default}"></span></div><span>${fmt(s.Count)} (${nicePct(p)})</span></div>`
    }).join('');
  }

  // ------- public entry point
  window.renderDashboard = function(payload){
    try{
      $('#loading').style.display='flex';
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      // defaults
      state.range = state.range || '24h';
      state.metric = state.metric || 'Reply %';
      state.agentType = state.agentType || 'All';
      state.chartType = state.chartType || 'funnel';

      renderHeader();
      populateSelectors();
      renderKPIs();
      renderChart();
      renderPipeline();
      sendHeight();
    }catch(e){ console.error(e); }
    finally{ $('#loading').style.display='none'; }
  };

  // ------- events
  $('#refresh').addEventListener('click',()=> location.reload());
  $('#range-select').addEventListener('change',e=>{ state.range=e.target.value; populateSelectors(); renderKPIs(); renderChart(); sendHeight(); });
  $('#metric-select').addEventListener('change',e=>{ state.metric=e.target.value; renderChart(); sendHeight(); });
  $('#agent-select').addEventListener('change',e=>{ state.agentType=e.target.value; renderHeader(); renderChart(); renderPipeline(); sendHeight(); });
  $('#chart-type-select').addEventListener('change',e=>{ state.chartType=e.target.value; renderChart(); sendHeight(); });
  $('#show-all-btn').addEventListener('click',()=>{ state.agentType='All'; $('#agent-select').value='All'; renderHeader(); renderChart(); renderPipeline(); sendHeight(); });
  $('#pipe-view').addEventListener('change',()=>{ renderPipeline(); sendHeight(); });

  // ------- resize -> parent
  function sendHeight(){ setTimeout(()=> parent.postMessage({type:'VQ_IFR_HEIGHT', height: document.body.scrollHeight }, '*'), 0); }
  window.addEventListener('resize', sendHeight);
  // update height whenever DOM mutates (charts/layout)
  new MutationObserver(()=>sendHeight()).observe(document.body,{childList:true,subtree:true});

  // Initial shell (in case host loads before data)
  document.addEventListener('DOMContentLoaded', ()=>{
    $('#biz-name').textContent='—';
    $('#agent-select').innerHTML='<option>All</option>';
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    $('#chart-type-select').value='funnel';
    sendHeight();
  });
})();
</script>
</body>
</html>
