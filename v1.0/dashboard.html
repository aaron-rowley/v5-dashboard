<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard (GHL v1.2)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215;
      --line:#2b2f36; --text:#ffffff; --muted:#c9ced8; --primary:#ed6c03; --primary-dark:#b94f00;
      --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25);
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --violet:#8b5cf6; --blue:#3b82f6; --teal:#14b8a6;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg-main); color:var(--text); margin:0; font-family:var(--font); height:auto; overflow:visible}

    /* Spinner-first experience */
    body.loading .wrap{ display:none; }
    body.loading #loader{ display:grid; }
    #loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,17,21,.85); z-index:9999; backdrop-filter:saturate(120%) blur(2px)}
    .spinner{width:88px; height:88px; border-radius:50%; background:radial-gradient(closest-side,rgba(237,108,3,.18),rgba(237,108,3,.04) 55%,transparent 60%);
      position:relative; box-shadow:0 0 60px rgba(237,108,3,.25)}
    .spinner:after{content:""; position:absolute; inset:10px; border-radius:50%; border:6px solid transparent; border-top-color:var(--primary);
      filter:drop-shadow(0 0 8px rgba(237,108,3,.9)); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Main layout */
    .wrap{width:100%; max-width:100%; margin:24px auto 80px; padding:0 16px}
    .section-title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .section-title h1{margin:0; font-size:20px; font-weight:800}
    .hint{color:var(--muted); font-size:.92rem}
    .pill{display:inline-flex; gap:8px; align-items:center; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:999px; padding:8px 12px; font-weight:700}
    .btn{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
    .btn:hover{background:var(--primary); border-color:var(--primary-dark)}
    .divider{height:1px; background:var(--line); margin:12px 0 18px}

    .controls{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; align-items:center;
      background:var(--bg-panel); border-radius:var(--radius); padding:12px; margin:8px 0 16px}
    .ctrl{grid-column:span 3; display:flex; flex-direction:column; gap:6px; min-width:0}
    .ctrl.small{grid-column:span 2}
    .label{color:var(--muted); font-size:.75rem; letter-spacing:.02em}
    select{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:600; width:100%}

    .grid-kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:8px 0 16px}
    .kpi{background:var(--bg-panel); border-radius:var(--radius); padding:18px; transition:box-shadow .25s, outline .25s}
    .kpi h4{margin:0 0 10px; color:var(--muted); font-weight:600; font-size:.95rem}
    .kpi .big{font-size:34px; font-weight:800; letter-spacing:.5px}
    .kpi .pillline{margin-top:8px; color:var(--muted)}
    .kpi .pillline strong{color:var(--primary)}
    .kpi.glow{ box-shadow:0 0 0 2px var(--primary), 0 0 24px rgba(237,108,3,.35); }

    .card{background:var(--bg-panel); border-radius:var(--radius); padding:14px}
    .section{background:var(--bg-panel); border-radius:var(--radius); padding:14px; margin-top:14px}

    .pipe-row{display:grid; grid-template-columns:1.5fr .6fr 3fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid var(--line)}
    .pipe-row:last-child{border-bottom:none}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px}
    .bar{height:8px; background:var(--bg-panel-2); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; border-radius:999px}

    /* responsive */
    @media (max-width:980px){
      .grid-kpi{grid-template-columns:1fr 1fr}
      .ctrl{grid-column:span 6}
      .ctrl.small{grid-column:span 6}
    }
    @media (max-width:640px){
      .grid-kpi{grid-template-columns:1fr}
      .ctrl{grid-column:span 12}
      .ctrl.small{grid-column:span 12}
    }
  </style>
</head>
<body class="loading">
<div id="loader"><div class="spinner"></div></div>

<div class="wrap">
  <div class="section-title">
    <div>
      <h1 id="company">—</h1>
      <div class="hint">Last updated on: <span id="last-updated">—</span></div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <div class="pill" id="agent-pill">Agent: <strong id="agent-pill-name">All</strong></div>
      <div class="pill" id="metric-pill" style="border-color:var(--line);">Metric: <strong id="metric-pill-name">Reply %</strong></div>
      <button class="btn" id="refresh-btn">Refresh metrics</button>
    </div>
  </div>

  <div class="divider"></div>

  <div class="controls" id="controls">
    <div class="ctrl small">
      <div class="label">Range</div>
      <select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="ctrl small">
      <div class="label">Metric</div>
      <select id="metric-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Agent</div>
      <select id="agent-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Quick</div>
      <button class="btn" id="show-all">Show All</button>
    </div>
    <div class="ctrl small">
      <div class="label">Chart</div>
      <select id="chart-select">
        <option value="funnel">Funnel</option>
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="donut">Donut</option>
        <option value="line">Line</option>
      </select>
    </div>
  </div>

  <div class="grid-kpi">
    <div class="kpi" id="kpi-contacted-card"><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div></div>
    <div class="kpi" id="kpi-replies-card"><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="pillline">Reply %: <strong id="kpi-replyPct">0.0%</strong></div></div>
    <div class="kpi" id="kpi-leads-card"><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="pillline">Contacted → Appt/Lead %: <strong id="kpi-c2l">0.0%</strong></div></div>
    <div class="kpi" id="kpi-sold-card"><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="pillline">Appt/Lead → Close %: <strong id="kpi-l2c">0.0%</strong></div></div>
  </div>

  <div class="card" id="chart-card">
    <div id="main-chart"></div>
  </div>

  <div class="section">
    <div class="section-title">
      <h3 id="pipe-title">Sales team pipeline audit info</h3>
      <div style="display:flex; align-items:center; gap:10px">
        <span class="label">View as</span>
        <select id="pipe-view">
          <option value="table">Table</option>
          <option value="bars">Horizontal bars</option>
          <option value="donut">Donut</option>
          <option value="line">Line</option>
        </select>
      </div>
    </div>
    <div id="pipeline-table"></div>
    <div id="pipeline-chart" style="display:none"></div>
    <div class="hint" id="pipe-total" style="margin-top:8px"></div>
  </div>
</div>

<script>
(function(){
  // helpers
  const $ = s => document.querySelector(s);
  const fmt = n => new Intl.NumberFormat().format(Math.round(Number(n)||0));
  const safeDiv = (a,b) => (b>0 ? (Number(a)||0)/(Number(b)||0) : 0);
  const pct = (num, den) => 100*safeDiv(num, den);
  const nicePct = v => `${(Number(v)||0).toFixed(1)}%`;
  const LINE = getComputedStyle(document.documentElement).getPropertyValue('--line').trim();

  const COLORS = {
    New:'#ED6C03', Lost:'#EF4444', Sold:'#22C55E', 'Needs Follow Up':'#F59E0B',
    Pipeline:'#8B5CF6', 'sold b/ai':'#3B82F6', Unchecked:'#60a5fa', Service:'#10b981',
    default:'#6B7280'
  };

  // metric → accent mapping (VisQuanta theme)
  const METRIC_ACCENTS = {
    'Reply %':'#ed6c03',
    'Contacted → Appt/Lead %':'#8b5cf6',
    'Appt/Lead → Close %':'#22c55e',
    'Contacted':'#3b82f6',
    'Replies':'#ed6c03',
    'Appointments / Leads':'#8b5cf6',
    'Sold':'#22c55e'
  };

  let DATA = {}; // payload
  let mainChart = null, pipeChart = null;
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'funnel', pipeView:'table' };

  const METRICS = [
    { label:'Reply %', key:'Reply %', pct:true },
    { label:'Contacted → Appt/Lead %', key:'Contacted → Appt/Lead %', pct:true },
    { label:'Appt/Lead → Close %', key:'Appt/Lead → Close %', pct:true },
    { label:'Contacted', key:'Contacted' },
    { label:'Replies', key:'Replies' },
    { label:'Appointments / Leads', key:'Appointments / Leads' },
    { label:'Sold', key:'Sold' }
  ];

  const getAgents = () => (DATA.agentsByRange?.[state.range]||[])
    .filter(a => a.agent && a.agent.toLowerCase()!=='cxa')
    .map(a => ({ name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0 }));

  const totalsOf = (arr) => arr.reduce((acc,c)=>{
    Object.keys(c).forEach(k=>{ if(k!=='name') acc[k]=(acc[k]||0)+(Number(c[k])||0); });
    return acc;
  },{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  const addDerived = (o) => ({
    ...o,
    'Reply %': pct(o.Replies, o.Contacted),
    'Contacted → Appt/Lead %': pct(o['Appointments / Leads'], o.Contacted),
    'Appt/Lead → Close %': pct(o.Sold, o['Appointments / Leads'])
  });

  function setMetricAccent(){
    const color = METRIC_ACCENTS[state.metric] || 'var(--primary)';
    const pill = $('#metric-pill');
    $('#metric-pill-name').textContent = state.metric;
    pill.style.borderColor = color;
    pill.style.boxShadow = `0 0 0 2px ${color} inset, 0 0 22px ${hexToRgba(color, .35)}`;

    // glow the matching KPI card
    ['kpi-contacted-card','kpi-replies-card','kpi-leads-card','kpi-sold-card'].forEach(id=>$('#'+id).classList.remove('glow'));
    if(state.metric==='Contacted') $('#kpi-contacted-card').classList.add('glow');
    if(state.metric==='Replies' || state.metric==='Reply %') $('#kpi-replies-card').classList.add('glow');
    if(state.metric==='Appointments / Leads' || state.metric==='Contacted → Appt/Lead %') $('#kpi-leads-card').classList.add('glow');
    if(state.metric==='Sold' || state.metric==='Appt/Lead → Close %') $('#kpi-sold-card').classList.add('glow');
  }

  function hexToRgba(hex, a){
    if(hex.startsWith('var')) return `rgba(237,108,3,${a||1})`;
    const v = hex.replace('#','');
    const r = parseInt(v.substring(0,2),16);
    const g = parseInt(v.substring(2,4),16);
    const b = parseInt(v.substring(4,6),16);
    return `rgba(${r},${g},${b},${a||1})`;
  }

  function populateSelectors(){
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    $('#metric-select').value = state.metric;
    const names = ['All', ...getAgents().map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
    $('#agent-select').value = state.agent;
    $('#range-select').value = state.range;
    $('#chart-select').value = state.chart;
    $('#pipe-view').value = state.pipeView;
    $('#agent-pill-name').textContent = state.agent;
    setMetricAccent();
  }

  function renderHeaderKPIs(){
    $('#company').textContent = DATA.company || 'Performance';
    const date = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = date.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

    const base = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent) || {Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
    const d = addDerived(base);
    $('#kpi-contacted').textContent = fmt(base.Contacted);
    $('#kpi-replies').textContent = fmt(base.Replies);
    $('#kpi-leads').textContent = fmt(base['Appointments / Leads']);
    $('#kpi-sold').textContent = fmt(base.Sold);
    $('#kpi-replyPct').textContent = nicePct(d['Reply %']);
    $('#kpi-c2l').textContent = nicePct(d['Contacted → Appt/Lead %']);
    $('#kpi-l2c').textContent = nicePct(d['Appt/Lead → Close %']);
  }

  function renderMainChart(){
    const agents = getAgents().map(addDerived);
    const selectedMetric = METRICS.find(m=>m.label===state.metric);

    let cats=[], dataVals=[];
    if(state.agent==='All'){
      cats = agents.map(a=>a.name);
      dataVals = agents.map(a=>Number(a[selectedMetric.key])||0);
    }else{
      const a = agents.find(x=>x.name===state.agent) || null;
      cats = ['Contacted','Replies','Appt/Leads','Sold'];
      dataVals = a ? [a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold].map(v=>Number(v)||0) : [0,0,0,0];
    }

    const yFmt = (v)=> selectedMetric?.pct ? `${Math.round(Number(v)||0)}%` : fmt(v);
    const accent = METRIC_ACCENTS[state.metric] || '#ed6c03';
    const usableType = (state.chart==='line' && (dataVals.filter(v=>v>0).length<2 || cats.length<2)) ? 'funnel' : state.chart;

    const opts = {
      colors:[accent],
      chart:{ toolbar:{show:false}, parentHeightOffset:0, foreColor:'#c9ced8' },
      dataLabels:{enabled:false}, grid:{borderColor:LINE, strokeDashArray:4},
      tooltip:{theme:'dark', y:{formatter:(val)=> selectedMetric?.pct ? `${(Number(val)||0).toFixed(1)}%` : fmt(val)}},
      legend:{labels:{colors:'#c9ced8'}}
    };

    if(usableType==='funnel'){
      const b = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent)||{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
      const seriesData = [
        {x:'Contacted', y:Number(b.Contacted)||0},
        {x:'Replies', y:Number(b.Replies)||0},
        {x:'ApptLeads', y:Number(b['Appointments / Leads'])||0},
        {x:'Sold', y:Number(b.Sold)||0}
      ];
      opts.chart.type='bar';
      opts.plotOptions={bar:{horizontal:true, borderRadius:6, barHeight:'40%'}};
      opts.xaxis={labels:{style:{colors:'#c9ced8'}}};
      opts.series=[{name:state.metric, data:seriesData}];
    } else if(usableType==='donut'){
      // prettier donuts
      opts.chart.type='donut';
      opts.series = dataVals.map(v=>Math.max(0, Number(v)||0));
      opts.labels = cats;
      opts.stroke={show:true, width:0};
      opts.dataLabels={enabled:true, formatter:(val)=> `${val.toFixed(1)}%`, style:{fontSize:'12px', fontWeight:700}};
      opts.legend={position:'right', labels:{colors:'#c9ced8'}};
      opts.plotOptions={
        pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label:'Total', formatter:(w)=> fmt(w.globals.seriesTotals.reduce((a,b)=>a+b,0)) }, value:{ show:false } } } }
      };
    } else if(usableType==='bar-h'){
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:true, borderRadius:6}};
      opts.xaxis={categories:cats, labels:{style:{colors:'#c9ced8'}}};
      opts.series=[{name:state.metric, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else if(usableType==='bar'){
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:false, borderRadius:6, columnWidth:'55%'}};
      opts.xaxis={categories:cats, labels:{style:{colors:'#c9ced8'}}};
      opts.series=[{name:state.metric, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else { // line
      opts.chart.type='line'; opts.stroke={curve:'smooth', width:3}; opts.markers={size:3};
      opts.xaxis={categories:cats, labels:{style:{colors:'#c9ced8'}}};
      opts.yaxis={labels:{style:{colors:'#c9ced8'}, formatter:yFmt}};
      opts.series=[{name:(state.agent==='All'?state.metric:state.agent), data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    }

    if(mainChart) mainChart.destroy();
    mainChart = new ApexCharts($('#main-chart'), {...opts, chart:{...opts.chart, height:380}});
    mainChart.render();
  }

  function getPipeTotals(){
    if(state.agent==='All') return (DATA.auditStatusTotals||[]);
    const agentBlock = (DATA.auditByAgent||[]).find(a=>a.agent===state.agent);
    return agentBlock ? agentBlock.totals || [] : [];
  }

  function renderPipeline(){
    const rows = getPipeTotals();
    const total = rows.reduce((s,r)=>s+(Number(r.Count)||0),0);
    $('#pipe-title').textContent = `Sales team pipeline audit info${state.agent==='All'?'':` — ${state.agent}`}`;
    $('#pipe-total').textContent = `Total Contacts: ${fmt(total)}`;

    const view = state.pipeView;
    $('#pipeline-table').style.display = view==='table'? 'block':'none';
    $('#pipeline-chart').style.display = view==='table'? 'none':'block';

    if(view==='table'){
      const html = rows.map(r=>{
        const count = Number(r.Count)||0;
        const p = pct(count, total);
        const color = COLORS[r.Status] || COLORS.default;
        return `<div class="pipe-row">
          <div><span class="dot" style="background:${color}"></span>${r.Status}</div>
          <div style="text-align:right">${fmt(count)} (${(p||0).toFixed(1)}%)</div>
          <div class="bar"><span style="width:${Math.max(0,p)}%; background:${color}"></span></div>
        </div>`;
      }).join('');
      $('#pipeline-table').innerHTML = html || '<div class="hint">No data.</div>';
    } else {
      const series = rows.map(r=>Math.max(0,(Number(r.Count)||0)));
      const labels = rows.map(r=>r.Status);
      const colors = rows.map(r=>COLORS[r.Status]||COLORS.default);
      const base = { chart:{toolbar:{show:false}, parentHeightOffset:0}, labels, colors, tooltip:{theme:'dark'}, legend:{labels:{colors:'#c9ced8'}} };

      if(view==='bars'){
        const opts = { ...base, chart:{...base.chart, type:'bar'}, plotOptions:{bar:{horizontal:true, borderRadius:6}}, xaxis:{categories:labels, labels:{style:{colors:'#c9ced8'}}}, series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:360}}); pipeChart.render();
      } else if(view==='donut'){
        const opts = { ...base, chart:{...base.chart, type:'donut'}, series, stroke:{show:true, width:0}, dataLabels:{enabled:true, formatter:(v)=>`${v.toFixed(1)}%`}, plotOptions:{ pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label:'Total', formatter:(w)=> fmt(series.reduce((a,b)=>a+b,0)) } } } } }, legend:{position:'right', labels:{colors:'#c9ced8'}} };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:360}}); pipeChart.render();
      } else { // line
        const opts = { ...base, colors:['#ed6c03'], chart:{...base.chart, type:'line'}, stroke:{curve:'smooth', width:3}, markers:{size:3}, xaxis:{categories:labels, labels:{style:{colors:'#c9ced8'}}}, series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:360}}); pipeChart.render();
      }
    }
  }

  const showLoader = (flag)=>{ document.body.classList.toggle('loading', !!flag); };

  function wire(){
    $('#range-select').addEventListener('change', e=>{ state.range=e.target.value; refreshAll(); });
    $('#metric-select').addEventListener('change', e=>{ state.metric=e.target.value; setMetricAccent(); refreshChartsOnly(); });
    $('#agent-select').addEventListener('change', e=>{ state.agent=e.target.value; $('#agent-pill-name').textContent = state.agent; refreshAll(); });
    $('#chart-select').addEventListener('change', e=>{ state.chart=e.target.value; renderMainChart(); sendHeight(); });
    $('#pipe-view').addEventListener('change', e=>{ state.pipeView=e.target.value; renderPipeline(); sendHeight(); });
    $('#show-all').addEventListener('click', ()=>{ state.agent='All'; $('#agent-select').value='All'; $('#agent-pill-name').textContent='All'; refreshAll(); });
    $('#refresh-btn').addEventListener('click', ()=> window.location.reload());
    window.addEventListener('resize', ()=> sendHeight());
    window.addEventListener('message', (e)=>{ const m=e?.data; if(!m) return; if(m.type==='VQ_METRICS'){ renderDashboard(m.payload); } if(m.type==='VQ_REQUEST_HEIGHT'){ sendHeight(); }});
  }

  function refreshAll(){ renderHeaderKPIs(); renderMainChart(); renderPipeline(); sendHeight(); }
  function refreshChartsOnly(){ renderMainChart(); renderPipeline(); sendHeight(); }

  function computedHeight(){
    return Math.max(
      document.body.scrollHeight, document.documentElement.scrollHeight,
      document.body.offsetHeight, document.documentElement.offsetHeight,
      document.body.clientHeight, document.documentElement.clientHeight
    );
  }
  function sendHeight(){ setTimeout(()=>{ parent.postMessage({type:'VQ_IFR_HEIGHT', height: computedHeight() }, '*'); }, 0); }
  const ro = new ResizeObserver(()=> sendHeight()); ro.observe(document.documentElement);

  window.renderDashboard = function(payload){
    try{
      showLoader(true);
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      state.range = '24h'; state.chart = 'funnel'; state.metric = state.metric || 'Reply %'; state.agent = 'All';
      populateSelectors(); refreshAll();
    }catch(err){ console.error('renderDashboard failed', err); }
    finally{ showLoader(false); }
  };

  document.addEventListener('DOMContentLoaded', ()=>{ populateSelectors(); wire(); sendHeight(); });
})();
</script>
</body>
</html>
