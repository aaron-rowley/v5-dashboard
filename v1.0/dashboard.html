<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agent Performance Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    /* (unchanged) --- your full CSS from the message --- */
    :root { --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215; --line:#2b2f36; --text-main:#ffffff; --text-muted:#a9b0bc; --primary:#ed6c03; --primary-dark:#b94f00; --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25); }
    *,*::before,*::after{box-sizing:border-box}
    html,body{background-color:var(--bg-main);margin:0;font-family:var(--font);color:var(--text-main)}
    #wrapper{max-width:1200px;margin:40px auto;padding:0 20px}
    .shell{background-color:transparent;padding:0}
    .header .title{font-size:26px;font-weight:700;margin:0 0 4px}
    .header .sub{color:var(--text-muted);font-size:1rem;margin:0 0 24px}
    .last-updated-bar{display:flex;align-items:center;justify-content:space-between;color:var(--text-muted);font-size:.9rem;margin-bottom:24px}
    .btn-refresh{background:none;border:1px solid var(--line);color:var(--text-main);border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:500;transition:.2s}
    .btn-refresh:hover{background-color:var(--primary);border-color:var(--primary-dark)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:24px}
    .kpi{background-color:var(--bg-panel);border-radius:var(--radius);padding:20px}
    .kpi h4{margin:0 0 8px;font-weight:500;color:var(--text-muted);font-size:1rem}
    .kpi .big{font-size:36px;font-weight:700;margin-bottom:12px}
    .kpi .pill{display:inline-block;font-size:.85rem;font-weight:500}
    .kpi .pill strong{color:var(--primary)}
    .controls{display:flex;flex-wrap:wrap;gap:16px;align-items:center;margin:24px 0;padding:16px;background-color:var(--bg-panel);border-radius:var(--radius)}
    .controls .label{color:var(--text-muted);font-weight:500;font-size:.9rem}
    .controls .select{appearance:none;background-color:var(--bg-panel-2);border:1px solid var(--line);color:var(--text-main);border-radius:8px;padding:10px 30px 10px 14px;font-size:.9rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.41 0.589966L6 5.16997L10.59 0.589966L12 1.99997L6 7.99997L0 1.99997L1.41 0.589966Z' fill='%23a9b0bc'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
    .controls .btn-show-all{background-color:var(--bg-panel-2);border:1px solid var(--line);color:var(--text-main);border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:500;transition:.2s}
    .controls .btn-show-all:hover{background-color:var(--primary);border-color:var(--primary-dark)}
    .chart-container{background-color:var(--bg-panel);border-radius:var(--radius);padding:20px}
    .grid-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px}
    .panel{background-color:var(--bg-panel);border-radius:var(--radius);padding:24px}
    .panel-title{font-size:1.25rem;font-weight:600;margin:0 0 20px 0}
    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--line);font-size:.95rem}
    .stat-row:last-child{border-bottom:none}
    .stat-row .label{color:var(--text-muted)}
    .stat-row .value{font-weight:600}
    .stat-row .value.highlight{color:var(--primary)}
    #all-agents-card .cta-button{margin-top:20px;width:100%;padding:12px;background:var(--bg-panel-2);border:1px solid var(--line);color:white;border-radius:8px;cursor:pointer;font-weight:600}
    #all-agents-card .cta-button:hover{background-color:#2c2f36}
    .pipeline-status-item{margin-bottom:16px}
    .pipeline-status-item .status-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:.9rem}
    .pipeline-status-item .status-label{display:flex;align-items:center;gap:8px;font-weight:500}
    .pipeline-status-item .status-dot{width:10px;height:10px;border-radius:50%}
    .pipeline-status-item .progress-bar{width:100%;height:8px;background-color:var(--bg-panel-2);border-radius:4px;overflow:hidden}
    .pipeline-status-item .progress-bar-inner{height:100%;border-radius:4px}
    .audit-container{grid-column:1 / -1;background-color:var(--bg-panel);border-radius:var(--radius);padding:24px}
    .audit-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .audit-tab{padding:8px 16px;border-radius:20px;background:var(--bg-element);border:1px solid var(--line);cursor:pointer;font-size:.9rem;font-weight:500}
    .audit-tab.active{background:var(--primary);border-color:var(--primary-dark);color:white}
    .audit-content{display:grid;grid-template-columns:3fr 4fr;gap:20px}
    .sub-panel{background-color:var(--bg-element);border:1px solid var(--line);border-radius:var(--radius);padding:20px}
    .sub-panel-title{font-size:1.1rem;font-weight:600;margin:0 0 16px}
    .agent-perf-item{margin-bottom:16px;border:1px solid var(--line);border-radius:10px;padding:16px}
    .agent-perf-item h5{margin:0 0 12px;font-size:1rem;font-weight:700;color:var(--primary)}
    .agent-perf-details{display:flex;gap:20px;flex-wrap:wrap}
    .contacts-container{grid-column:1 / -1;background-color:var(--bg-panel);border-radius:var(--radius);padding:24px}
    .contacts-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .contacts-search input{background-color:var(--bg-panel-2);border:1px solid var(--line);border-radius:8px;padding:10px 14px;color:var(--text-main);width:250px}
    .contacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .contact-card{background-color:var(--bg-element);border:1px solid var(--line);border-radius:10px;padding:16px}
    .contact-card .name{font-weight:600;font-size:1.1rem}
    .contact-card .id{color:var(--text-muted);font-size:.8rem;margin:4px 0 12px}
    .contact-card .tag{display:inline-block;padding:4px 10px;border-radius:6px;font-size:.75rem;font-weight:700;text-transform:uppercase;background-color:var(--primary);color:white}
    .contact-card .btn-details{width:100%;margin-top:16px;padding:10px;border:1px solid var(--line);background-color:var(--bg-panel-2);color:var(--text-main);border-radius:8px;cursor:pointer}
    #load-more-contacts{display:block;margin:24px auto 0;width:200px;padding:12px;background:var(--bg-panel-2);border:1px solid var(--line);color:white;border-radius:8px;cursor:pointer;font-weight:600}
    @media (max-width:900px){.grid-layout,.audit-content{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div id="wrapper">
  <div class="shell">
    <div class="header">
      <h1 class="title" id="biz-name">Genesis of Norman</h1>
      <p class="sub">Agent Performance Intelligence Suite</p>
    </div>

    <div class="last-updated-bar">
      <span>Last updated on: <strong id="last-updated">—</strong></span>
      <button class="btn-refresh" id="refresh">Refresh metrics</button>
    </div>

    <div class="kpis" id="kpis-grid"></div>

    <div class="controls">
      <span class="label">Range:</span>
      <select class="select" id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
      <span class="label">Metric:</span>
      <select class="select" id="metric-select"></select>
      <span class="label">Agent Type:</span>
      <select class="select" id="agent-select"></select>
      <span class="label">Chart:</span>
      <select class="select" id="chart-type-select">
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="line">Line</option>
      </select>
      <button class="btn-show-all" id="show-all-btn">Show All</button>
    </div>

    <div class="chart-container" id="main-chart-container"></div>

    <div class="grid-layout">
      <div class="panel" id="all-agents-card"></div>
      <div class="panel" id="pipeline-status-panel"></div>
      
      <div class="audit-container">
        <h3 class="panel-title">Pipeline Audit</h3>
        <div class="audit-tabs" id="audit-tabs"></div>
        <div class="audit-content">
          <div class="sub-panel" id="audit-status-overview"></div>
          <div class="sub-panel" id="audit-agent-performance"></div>
        </div>
      </div>
      
      <div class="contacts-container">
        <div class="contacts-header">
            <h3 class="panel-title">Contacts Database</h3>
            <div class="contacts-search">
                <input type="text" id="contact-search" placeholder="Search by name or contact ID...">
            </div>
        </div>
        <div class="contacts-grid" id="contacts-grid"></div>
        <button id="load-more-contacts">Load More Contacts</button>
      </div>
    </div>
  </div>
</div>

<!-- Optional inline JSON fallback (unused when using loader/postMessage) -->
<script id="json-agent-metrics" type="application/json">
  {{ custom_values.v50_dashboard__metric_data }}
</script>

<script>
  (function() {
    // --- DATA FETCHING & SAMPLE DATA ---
    const rawNode = document.getElementById('json-agent-metrics');
    let src = (rawNode && rawNode.textContent || '').trim();
    let DATA;
    try {
      DATA = JSON.parse(src);
    } catch (e) {
      DATA = {}; // keep empty; will hydrate via postMessage
    }

    // --- STATE & CONSTANTS ---
    const state = { range: '24h', metric: 'Reply %', agentType: 'All', chartType: 'bar', auditAgent: 'All Agents*' };
    const METRICS = [
      { label: 'Reply %', key: 'Reply %', isPct: true },
      { label: 'Contacted → Appt/Lead %', key: 'Contacted → Appt/Lead %', isPct: true },
      { label: 'Appt/Lead → Close %', key: 'Appt/Lead → Close %', isPct: true },
      { label: 'Contacted → Close %', key: 'Contacted → Close %', isPct: true },
      { label: 'Contacted', key: 'Contacted', isPct: false },
      { label: 'Replies', key: 'Replies', isPct: false },
      { label: 'Appointments / Leads', key: 'Appointments / Leads', isPct: false },
      { label: 'Sold', key: 'Sold', isPct: false }
    ];
    const PIPELINE_COLORS = {
      "New":"#ED6C03","Lost":"#EF4444","Sold":"#22C55E","Needs Follow Up":"#F59E0B",
      "Pipeline":"#8B5CF6","sold b/ai":"#3B82F6","default":"#6B7280"
    };
    let mainChart = null;

    // --- HELPERS ---
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const fmt = n => new Intl.NumberFormat().format(Math.round(n || 0));
    const pct = (num, den) => den > 0 ? (100 * num / den) : 0;
    const nicePct = v => `${parseFloat(v || 0).toFixed(1)}%`;
    const getAgentData = range => (DATA.agentsByRange?.[range] || []).filter(a => a.agent.toLowerCase() !== 'cxa').map(a => ({
      name: a.agent,
      Contacted: a.outbound || 0,
      Replies: a.inbound || 0,
      'Appointments / Leads': a.leads || 0,
      Sold: a.sold || 0,
    }));
    const computeMetrics = data => ({
      ...data,
      'Reply %': pct(data.Replies, data.Contacted),
      'Contacted → Appt/Lead %': pct(data['Appointments / Leads'], data.Contacted),
      'Appt/Lead → Close %': pct(data.Sold, data['Appointments / Leads']),
      'Contacted → Close %': pct(data.Sold, data.Contacted)
    });

    // --- RENDER FUNCTIONS ---
    function renderHeader() {
      $('#biz-name').textContent = DATA.company || 'Agent Performance';
      const date = new Date(DATA.generatedAtUTC || Date.now());
      $('#last-updated').textContent = date.toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function renderKPIs() {
      const d = DATA.byRange?.[state.range] || {};
      const contacted = d.messages?.outbound || 0;
      const replies = d.messages?.inbound || 0;
      const leads = d.leads || 0;
      const sold = d.sold || 0;

      const kpiData = [
        { title: 'Prospects contacted', big: fmt(contacted), pill: `Reply %: <strong>${nicePct(pct(replies, contacted))}</strong>` },
        { title: 'Replies', big: fmt(replies) },
        { title: 'Appointments / Leads', big: fmt(leads), pill: `Contacted → Appt/Lead %: <strong>${nicePct(pct(leads, contacted))}</strong>` },
        { title: 'Contacted → Close %', big: `${nicePct(pct(sold, contacted))}`, pill: `Sold: <strong>${fmt(sold)}</strong>` }
      ];

      $('#kpis-grid').innerHTML = kpiData.map(k => `
        <div class="kpi">
          <h4>${k.title}</h4>
          <div class="big">${k.big}</div>
          ${k.pill ? `<div class="pill">${k.pill}</div>` : ''}
        </div>
      `).join('');
    }

    function renderMainChart() {
      const allAgents = getAgentData(state.range).map(computeMetrics);
      const selectedMetric = METRICS.find(m => m.label === state.metric);

      let seriesData, categories;
      if (state.agentType === 'All') {
        categories = allAgents.map(a => a.name);
        seriesData = [{ name: selectedMetric.label, data: allAgents.map(a => a[selectedMetric.key] || 0) }];
      } else {
        const agent = allAgents.find(a => a.name === state.agentType);
        if (agent) {
          categories = ['Contacted', 'Replies', 'Appt/Leads', 'Sold'];
          seriesData = [{ name: agent.name, data: [agent.Contacted, agent.Replies, agent['Appointments / Leads'], agent.Sold] }];
        } else { categories = []; seriesData = []; }
      }

      const VAR = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
        line: getComputedStyle(document.documentElement).getPropertyValue('--line').trim(),
        text_muted: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()
      };

      const options = {
        series: seriesData,
        chart: { type: state.chartType === 'line' ? 'line' : 'bar', height: 350, toolbar: { show: false }, parentHeightOffset: 0 },
        plotOptions: { bar: { horizontal: state.chartType === 'bar-h', borderRadius: 6, columnWidth: '55%' } },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 3 },
        colors: [VAR.primary],
        grid: { borderColor: VAR.line, strokeDashArray: 4 },
        xaxis: { categories, labels: { style: { colors: VAR.text_muted } }, axisBorder: { show: false }, axisTicks: { show: false } },
        yaxis: { labels: { style: { colors: VAR.text_muted }, formatter: val => (state.agentType === 'All' && METRICS.find(m=>m.label===state.metric)?.isPct) ? `${Math.round(val)}%` : fmt(val) } },
        tooltip: { theme: 'dark' }
      };

      if (mainChart) mainChart.destroy();
      mainChart = new ApexCharts(document.querySelector('#main-chart-container'), options);
      mainChart.render();
    }

    function renderAllAgentsCard() {
      const agents = getAgentData(state.range);
      const totals = agents.reduce((acc, curr) => {
        Object.keys(curr).forEach(key => { if (key !== 'name') acc[key] = (acc[key] || 0) + curr[key]; });
        return acc;
      }, {});
      const totalsWithMetrics = computeMetrics(totals);

      const stats = [
        { label: 'Contacted', value: fmt(totalsWithMetrics.Contacted) },
        { label: 'Replies', value: fmt(totalsWithMetrics.Replies) },
        { label: 'Appointments / Leads', value: fmt(totalsWithMetrics['Appointments / Leads']) },
        { label: 'Sold', value: fmt(totalsWithMetrics.Sold) },
        { label: 'Reply %', value: nicePct(totalsWithMetrics['Reply %']), highlight: true },
        { label: 'Contacted → Appt/Lead %', value: nicePct(totalsWithMetrics['Contacted → Appt/Lead %']), highlight: true },
        { label: 'Appt/Lead → Close %', value: nicePct(totalsWithMetrics['Appt/Lead → Close %']), highlight: true }
      ];

      document.querySelector('#all-agents-card').innerHTML = `
        <h3 class="panel-title">All Agents*</h3>
        ${stats.map(s => `
          <div class="stat-row">
            <span class="label">${s.label}</span>
            <span class="value ${s.highlight ? 'highlight' : ''}">${s.value}</span>
          </div>
        `).join('')}
        <button class="cta-button">View contacts</button>
      `;
    }

    function renderPipelineStatus() {
      const statuses = DATA.auditStatusTotals || [];
      const total = statuses.reduce((sum, s) => sum + s.Count, 0);

      document.querySelector('#pipeline-status-panel').innerHTML = `
        <h3 class="panel-title">Pipeline Status</h3>
        <div id="pipeline-status-list">
          ${statuses.map(s => `
            <div class="pipeline-status-item">
              <div class="status-header">
                <span class="status-label">
                  <span class="status-dot" style="background-color:${( { "New":"#ED6C03","Lost":"#EF4444","Sold":"#22C55E","Needs Follow Up":"#F59E0B","Pipeline":"#8B5CF6","sold b/ai":"#3B82F6","default":"#6B7280"}[s.Status] || "#6B7280" )};"></span>
                  ${s.Status}
                </span>
                <span><strong>${fmt(s.Count)}</strong> (${nicePct(pct(s.Count, total))})</span>
              </div>
              <div class="progress-bar">
                <div class="progress-bar-inner" style="width:${pct(s.Count, total)}%;background-color:${( { "New":"#ED6C03","Lost":"#EF4444","Sold":"#22C55E","Needs Follow Up":"#F59E0B","Pipeline":"#8B5CF6","sold b/ai":"#3B82F6","default":"#6B7280"}[s.Status] || "#6B7280" )};"></div>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="stat-row" style="padding-top:16px;">
          <span class="label">Total Contacts</span>
          <span class="value">${fmt(total)}</span>
        </div>
      `;
    }

    function renderAudit() {
      const agents = ['All Agents*', ...getAgentData(state.range).map(a => a.name)];
      document.querySelector('#audit-tabs').innerHTML = agents.map(name => `
        <div class="audit-tab ${name === state.auditAgent ? 'active' : ''}" data-agent="${name}">${name}</div>
      `).join('');

      const allStatuses = DATA.auditStatusTotals || [];
      document.querySelector('#audit-status-overview').innerHTML = `
        <h4 class="sub-panel-title">Status Overview</h4>
        ${allStatuses.map(s => `
          <div class="stat-row">
            <span class="label">${s.Status}</span>
            <span class="value">${fmt(s.Count)}</span>
          </div>
        `).join('')}
        <div class="stat-row" style="font-weight:700;">
          <span class="label">Total</span>
          <span class="value">${fmt(allStatuses.reduce((sum, s) => sum + s.Count, 0))}</span>
        </div>
      `;

      const agentPerfs = DATA.auditByAgent || [];
      document.querySelector('#audit-agent-performance').innerHTML = `
        <h4 class="sub-panel-title">Agent Performance</h4>
        ${agentPerfs.map(ap => `
          <div class="agent-perf-item">
            <h5>${ap.agent}</h5>
            <div class="agent-perf-details">
              ${ap.totals.map(t => `<span>${t.Status}: <strong>${fmt(t.Count)}</strong></span>`).join('')}
            </div>
          </div>
        `).join('')}
      `;
    }

    function renderContacts() {
      const contacts = DATA.allContacts || [];
      const query = (document.querySelector('#contact-search')?.value || '').toLowerCase();
      const filtered = contacts.filter(c =>
        (c.name || '').toLowerCase().includes(query) || (c.id || '').toLowerCase().includes(query)
      );

      document.querySelector('#contacts-grid').innerHTML = filtered.slice(0, 10).map(c => `
        <div class="contact-card">
          <div class="name">${c.name}</div>
          <div class="id">ID: ${c.id}</div>
          ${c.tag ? `<div class="tag">${c.tag}</div>` : ''}
          <button class="btn-details">View Details</button>
        </div>
      `).join('');
    }

    // --- INITIALIZATION & EVENTS ---
    function init() {
      document.querySelector('#metric-select').innerHTML = METRICS.map(m => `<option>${m.label}</option>`).join('');
      const agentNames = ['All', ...getAgentData(state.range).map(a => a.name)];
      document.querySelector('#agent-select').innerHTML = agentNames.map(name => `<option value="${name}">${name}</option>`).join('');

      renderHeader(); renderKPIs(); renderMainChart(); renderAllAgentsCard(); renderPipelineStatus(); renderAudit(); renderContacts();

      document.querySelector('#refresh').addEventListener('click', () => location.reload());

      document.querySelector('#range-select').addEventListener('change', e => {
        state.range = e.target.value; renderKPIs(); renderAllAgentsCard(); renderMainChart();
      });
      document.querySelector('#metric-select').addEventListener('change', e => { state.metric = e.target.value; renderMainChart(); });
      document.querySelector('#agent-select').addEventListener('change', e => { state.agentType = e.target.value; renderMainChart(); });
      document.querySelector('#chart-type-select').addEventListener('change', e => { state.chartType = e.target.value; renderMainChart(); });
      document.querySelector('#show-all-btn').addEventListener('click', () => { state.agentType = 'All'; document.querySelector('#agent-select').value = 'All'; renderMainChart(); });
      document.querySelector('#audit-tabs').addEventListener('click', e => {
        if (e.target.classList.contains('audit-tab')) { state.auditAgent = e.target.dataset.agent; renderAudit(); }
      });
      document.querySelector('#contact-search').addEventListener('input', renderContacts);
    }

    // Expose a hydrator so parent can send JSON after iframe loads
    window.VQ_HYDRATE = function(payload) {
      try { DATA = typeof payload === 'string' ? JSON.parse(payload) : payload; }
      catch(e){ console.warn('VQ_HYDRATE: invalid JSON'); return; }
      // If first time, run full init; otherwise just re-render
      if (!window.__VQ_INIT) { window.__VQ_INIT = true; document.addEventListener('DOMContentLoaded', init); }
      else { renderHeader(); renderKPIs(); renderMainChart(); renderAllAgentsCard(); renderPipelineStatus(); renderAudit(); renderContacts(); }
    };

    // If inline JSON was valid, use it (handy for local preview)
    if (Object.keys(DATA).length) {
      window.__VQ_INIT = true;
      document.addEventListener('DOMContentLoaded', init);
    }

    // HYDRATE + postMessage listener (from loader on parent page)
    window.addEventListener('message', (event) => {
      if (!event.data) return;
      const { type, payload } = event.data;
      if (type === 'VQ_METRICS') window.VQ_HYDRATE(payload);
    });
  })();
</script>

</body>
</html>
