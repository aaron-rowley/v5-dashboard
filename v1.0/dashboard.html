<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agent Performance Dashboard (v1.1)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115;--bg-panel:#17191e;--bg-panel-2:#21242b;--bg-element:#101215;
      --line:#2b2f36;--text-main:#fff;--text-muted:#a9b0bc;--primary:#ed6c03;--primary-dark:#b94f00;
      --radius:12px;--font:'Outfit',sans-serif;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{margin:0;background:var(--bg-main);color:var(--text-main);font-family:var(--font)}
    #wrapper{max-width:1200px;margin:40px auto;padding:0 20px}
    .header .flow{margin:4px 0 16px;color:var(--text-muted);font-weight:600}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--bg-panel);border-radius:12px;padding:14px 16px;margin:8px 0 16px}
    .bar .group{display:flex;align-items:center;gap:8px}
    .label{color:var(--text-muted);font-size:.9rem;font-weight:600}
    select,.btn{appearance:none;background:var(--bg-panel-2);border:1px solid var(--line);color:var(--text-main);border-radius:8px;padding:10px 14px;font-size:.9rem}
    .btn{cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:12px 0 20px}
    .kpi{background:var(--bg-panel);border-radius:12px;padding:18px}
    .kpi h4{margin:0 0 8px;color:var(--text-muted);font-weight:600}
    .kpi .big{font-size:34px;font-weight:800}
    .kpi .pill{margin-top:8px;font-size:.9rem}
    .kpi .pill strong{color:var(--primary)}
    .panel{background:var(--bg-panel);border-radius:12px;padding:20px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .stat-row{display:flex;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 0}
    .stat-row:last-child{border-bottom:none}
    .muted{color:var(--text-muted)}
    @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="wrapper">
  <div class="header">
    <h2 id="biz-name" style="margin:0 0 2px">—</h2>
    <div class="flow">Prospects contacted → Replies → Appts / Leads → Closed</div>
    <div class="muted">Last updated on: <strong id="last-updated">—</strong> &nbsp;&nbsp;
      <button id="refresh" class="btn">Refresh metrics</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="bar">
    <div class="group"><span class="label">Range</span>
      <select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="group"><span class="label">Metric</span>
      <select id="metric-select"></select>
    </div>
    <div class="group"><span class="label">Agent</span>
      <select id="agent-select"></select>
      <button class="btn" id="show-all-btn">Show All</button>
    </div>
    <div class="group"><span class="label">Chart</span>
      <select id="chart-type-select">
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="line">Line</option>
        <option value="donut">Donut</option>
        <option value="funnel">Funnel</option>
      </select>
    </div>
  </div>

  <!-- KPI row -->
  <div class="kpis">
    <div class="kpi"><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div><div class="pill" id="pill-1"></div></div>
    <div class="kpi"><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="pill">Reply %: <strong id="pill-reply">0.0%</strong></div></div>
    <div class="kpi"><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="pill">Contacted → Appt/Lead %: <strong id="pill-c2l">0.0%</strong></div></div>
    <div class="kpi"><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="pill">Appt/Lead → Close %: <strong id="pill-l2c">0.0%</strong></div></div>
  </div>

  <!-- Main chart -->
  <div class="panel"><div id="main-chart"></div></div>

  <!-- Two responsive cards -->
  <div class="grid-2">
    <div class="panel" id="summary-card"></div>
    <div class="panel" id="pipeline-card"></div>
  </div>
</div>

<script>
(function(){
  // ---------- helpers
  const $ = s => document.querySelector(s);
  const fmt = n => new Intl.NumberFormat().format(Math.round(n||0));
  const pct = (num, den) => den>0 ? (100*num/den) : 0;
  const p1 = v => `${(v||0).toFixed(1)}%`;
  const VAR = {
    primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
    line: getComputedStyle(document.documentElement).getPropertyValue('--line').trim(),
    textMuted: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()
  };

  // ---------- state + data
  let DATA = {};
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'bar' };
  let chart = null;

  // metrics catalog
  const METRICS = [
    { label:'Reply %', key:'Reply %', isPct:true, tip:(a)=>`Replies / Contacted = ${fmt(a.Replies)} / ${fmt(a.Contacted)}` },
    { label:'Contacted → Appt/Lead %', key:'Contacted → Appt/Lead %', isPct:true, tip:(a)=>`Leads / Contacted = ${fmt(a['Appointments / Leads'])} / ${fmt(a.Contacted)}` },
    { label:'Appt/Lead → Close %', key:'Appt/Lead → Close %', isPct:true, tip:(a)=>`Sold / Leads = ${fmt(a.Sold)} / ${fmt(a['Appointments / Leads'])}` },
    { label:'Contacted → Close %', key:'Contacted → Close %', isPct:true, tip:(a)=>`Sold / Contacted = ${fmt(a.Sold)} / ${fmt(a.Contacted)}` },
    { label:'Contacted', key:'Contacted', isPct:false, tip:()=>`` },
    { label:'Replies', key:'Replies', isPct:false, tip:()=>`` },
    { label:'Appointments / Leads', key:'Appointments / Leads', isPct:false, tip:()=>`` },
    { label:'Sold', key:'Sold', isPct:false, tip:()=>`` },
  ];

  // data transforms
  const getAgents = (range)=> (DATA.agentsByRange?.[range]||[])
    .filter(a=>a.agent && a.agent.toLowerCase()!=='cxa')
    .map(a=>({ name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0 }));

  const withDerived = (row)=>({
    ...row,
    'Reply %': pct(row.Replies,row.Contacted),
    'Contacted → Appt/Lead %': pct(row['Appointments / Leads'],row.Contacted),
    'Appt/Lead → Close %': pct(row.Sold,row['Appointments / Leads']),
    'Contacted → Close %': pct(row.Sold,row.Contacted),
  });

  const totalOf = (rows)=> rows.reduce((acc,r)=>{
    for(const k of Object.keys(r)) if(k!=='name') acc[k]=(acc[k]||0)+(r[k]||0);
    return acc;
  },{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  // ---------- renderers
  function renderHeader(){
    $('#biz-name').textContent = DATA.company || '—';
    $('#last-updated').textContent = new Date(DATA.generatedAtUTC||Date.now())
      .toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
  }

  function renderKPIs(){
    const by = DATA.byRange?.[state.range] || {};
    const contacted = by.messages?.outbound||0;
    const replies = by.messages?.inbound||0;
    const leads = by.leads||0;
    const sold = by.sold||0;

    $('#kpi-contacted').textContent = fmt(contacted);
    $('#kpi-replies').textContent   = fmt(replies);
    $('#kpi-leads').textContent     = fmt(leads);
    $('#kpi-sold').textContent      = fmt(sold);

    $('#pill-1').textContent        = ''; // blank on card 1
    $('#pill-reply').textContent    = p1(pct(replies,contacted));
    $('#pill-c2l').textContent      = p1(pct(leads,contacted));
    $('#pill-l2c').textContent      = p1(pct(sold,leads));
  }

  function renderMainChart(){
    const rows = getAgents(state.range).map(withDerived);
    const m = METRICS.find(x=>x.label===state.metric);

    // when a single agent is chosen, we show that agent’s bar/line series of raw steps;
    // donut shows split of the chosen metric across agents; funnel shows single agent funnel.
    let options;

    if(state.chart==='donut'){
      options = {
        series: rows.map(r=> r[m.key]||0),
        chart:{ type:'donut', height:360 },
        labels: rows.map(r=>r.name),
        tooltip:{ theme:'dark', y:{ formatter:(v,ctx)=>{
          const a = rows[ctx.seriesIndex];
          const tip = m.tip(a);
          return m.isPct ? `${p1(v)} — ${tip}` : `${fmt(v)} — ${tip}`;
        }}},
        legend:{ labels:{ colors:VAR.textMuted } }
      };
    } else if (state.chart==='funnel'){
      // funnel only meaningful for a specific agent; if All, use totals
      const agentRow = (state.agent!=='All') ? rows.find(r=>r.name===state.agent) : withDerived(totalOf(rows));
      const steps = [
        {name:'Contacted', val:agentRow.Contacted},
        {name:'Replies', val:agentRow.Replies},
        {name:'Appt/Leads', val:agentRow['Appointments / Leads']},
        {name:'Sold', val:agentRow.Sold},
      ];
      options = {
        series:[{ data: steps.map(s=>s.val) }],
        chart:{ type:'bar', height:360 },
        plotOptions:{ bar:{ horizontal:true, distributed:true, barHeight:'70%' } },
        xaxis:{ categories: steps.map(s=>s.name), labels:{ style:{ colors:VAR.textMuted } } },
        yaxis:{ labels:{ style:{ colors:VAR.textMuted } } },
        grid:{ borderColor:VAR.line, strokeDashArray:4 },
        colors:['#e67e22','#f39c12','#3498db','#2ecc71'],
        tooltip:{ theme:'dark', y:{ formatter:(v,ctx)=>{
          const i = ctx.dataPointIndex;
          if(i===1) return `${fmt(v)} — Reply % = ${fmt(agentRow.Replies)} / ${fmt(agentRow.Contacted)} = ${p1(pct(agentRow.Replies,agentRow.Contacted))}`;
          if(i===2) return `${fmt(v)} — C→Lead % = ${fmt(agentRow['Appointments / Leads'])} / ${fmt(agentRow.Contacted)} = ${p1(pct(agentRow['Appointments / Leads'],agentRow.Contacted))}`;
          if(i===3) return `${fmt(v)} — Lead→Close % = ${fmt(agentRow.Sold)} / ${fmt(agentRow['Appointments / Leads'])} = ${p1(pct(agentRow.Sold,agentRow['Appointments / Leads']))}`;
          return fmt(v);
        }}}
      };
    } else {
      // bar/line
      let categories, series;
      if(state.agent==='All'){
        categories = rows.map(r=>r.name);
        series = [{name:m.label, data: rows.map(r=>r[m.key]||0)}];
      } else {
        const a = rows.find(r=>r.name===state.agent) || {Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0};
        const agentSeries = [a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold];
        categories = ['Contacted','Replies','Appt/Leads','Sold'];
        series = [{name:state.agent, data: agentSeries}];
      }

      options = {
        series,
        chart:{ type: state.chart==='line'?'line':'bar', height:360, toolbar:{show:false}},
        plotOptions:{ bar:{ horizontal: state.chart==='bar-h', borderRadius:6, columnWidth:'55%' } },
        dataLabels:{ enabled:false },
        stroke:{ curve:'smooth', width:3 },
        colors:[VAR.primary],
        grid:{ borderColor:VAR.line, strokeDashArray:4 },
        xaxis:{ categories, labels:{ style:{ colors:VAR.textMuted }}, axisBorder:{show:false}, axisTicks:{show:false} },
        yaxis:{ labels:{ style:{ colors:VAR.textMuted }, formatter:(v)=> m.isPct? `${Math.round(v)}%` : fmt(v)} },
        tooltip:{ theme:'dark', y:{ formatter:(v,ctx)=>{
          const idx = ctx.dataPointIndex;
          if(state.agent==='All'){
            const a = rows[idx];
            const tip = m.tip(a);
            return m.isPct ? `${p1(v)} — ${tip}` : `${fmt(v)} — ${tip}`;
          } else {
            const a = withDerived(totalOf([{Contacted:series[0].data[0],Replies:series[0].data[1],'Appointments / Leads':series[0].data[2],Sold:series[0].data[3]}]));
            const tip = m.tip(a);
            return m.isPct ? `${p1(v)} — ${tip}` : `${fmt(v)} — ${tip}`;
          }
        }}}
      };
    }

    if(chart) chart.destroy();
    chart = new ApexCharts($('#main-chart'), options);
    chart.render();
  }

  function renderSummaryAndPipeline(){
    const rows = getAgents(state.range);
    const rowsD = rows.map(withDerived);

    const selected = (state.agent!=='All')
      ? rowsD.find(r=>r.name===state.agent) || withDerived({Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0})
      : withDerived(totalOf(rows));

    // Summary card (changes with agent)
    $('#summary-card').innerHTML = `
      <h3 style="margin:0 0 12px">${state.agent==='All'?'All Agents*':state.agent}</h3>
      <div class="stat-row"><span class="muted">Contacted</span><span>${fmt(selected.Contacted)}</span></div>
      <div class="stat-row"><span class="muted">Replies</span><span>${fmt(selected.Replies)}</span></div>
      <div class="stat-row"><span class="muted">Appointments / Leads</span><span>${fmt(selected['Appointments / Leads'])}</span></div>
      <div class="stat-row"><span class="muted">Sold</span><span>${fmt(selected.Sold)}</span></div>
      <div class="stat-row"><span class="muted">Reply %</span><span>${p1(selected['Reply %'])}</span></div>
      <div class="stat-row"><span class="muted">Contacted → Appt/Lead %</span><span>${p1(selected['Contacted → Appt/Lead %'])}</span></div>
      <div class="stat-row"><span class="muted">Appt/Lead → Close %</span><span>${p1(selected['Appt/Lead → Close %'])}</span></div>
    `;

    // Pipeline card (filters to agent when possible)
    const allStatuses = DATA.auditStatusTotals||[];
    const byAgent = DATA.auditByAgent||[];
    const agentBlock = byAgent.find(x=>x.agent===state.agent);
    const statuses = (state.agent!=='All' && agentBlock) ? agentBlock.totals : allStatuses;
    const total = statuses.reduce((s,x)=> s + (x.Count||0), 0);
    $('#pipeline-card').innerHTML = `
      <h3 style="margin:0 0 12px">Pipeline Status ${state.agent!=='All' ? `– ${state.agent}` : ''}</h3>
      ${statuses.map(s=>`
        <div class="stat-row">
          <span class="muted">${s.Status}</span>
          <span>${fmt(s.Count||0)} (${p1(pct(s.Count||0,total||0))})</span>
        </div>`).join('')}
      <div class="stat-row"><span class="muted">Total</span><span>${fmt(total)}</span></div>
    `;
  }

  function populateSelectors(){
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    const names = ['All', ...getAgents(state.range).map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
  }

  function wireUI(){
    $('#refresh').addEventListener('click', ()=> location.reload());
    $('#range-select').addEventListener('change', e=>{ state.range=e.target.value; populateSelectors(); renderKPIs(); renderMainChart(); renderSummaryAndPipeline(); });
    $('#metric-select').addEventListener('change', e=>{ state.metric=e.target.value; renderMainChart(); });
    $('#agent-select').addEventListener('change', e=>{ state.agent=e.target.value; renderMainChart(); renderSummaryAndPipeline(); });
    $('#chart-type-select').addEventListener('change', e=>{ state.chart=e.target.value; renderMainChart(); });
    $('#show-all-btn').addEventListener('click', ()=>{ state.agent='All'; $('#agent-select').value='All'; renderMainChart(); renderSummaryAndPipeline(); });
  }

  // public entry
  window.renderDashboard = function(payload){
    try{
      DATA = typeof payload==='string' ? JSON.parse(payload||'{}') : (payload||{});
      renderHeader();
      populateSelectors();
      renderKPIs();
      renderMainChart();
      renderSummaryAndPipeline();
      setTimeout(()=> parent.postMessage({type:'VQ_IFR_HEIGHT',height:document.body.scrollHeight},'*'), 0);
    }catch(e){ console.error(e); }
  };

  // accept postMessage
  window.addEventListener('message', (e)=>{
    if(e?.data?.type==='VQ_METRICS') window.renderDashboard(e.data.payload);
  });

  // boot UI skeleton
  document.addEventListener('DOMContentLoaded', ()=>{ wireUI(); });
})();
</script>
</body>
</html>
