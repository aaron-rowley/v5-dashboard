<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agent Performance Dashboard (v6)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115;--bg-panel:#17191e;--bg-panel-2:#21242b;--bg-element:#101215;
      --line:#2b2f36;--text:#ffffff;--muted:#a9b0bc;--primary:#ed6c03;--primary-2:#ff8b32;
      --radius:12px;--font:'Outfit',sans-serif;--shadow:0 8px 32px rgba(0,0,0,.25);
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{margin:0;background:var(--bg-main);color:var(--text);font-family:var(--font);}
    body{overflow-x:hidden}

    #wrapper{max-width:1440px;margin:28px auto;padding:0 20px}
    .header{display:flex;align-items:center;justify-content:space-between;margin:0 0 12px}
    .title{font-size:24px;font-weight:700;margin:0}
    .muted{color:var(--muted)}
    .btn{background:var(--bg-panel-2);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn:hover{background:var(--primary)}

    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--bg-panel);border-radius:var(--radius);padding:12px;margin:14px 0 18px}
    .controls .group{display:flex;align-items:center;gap:8px}
    .label{color:var(--muted);font-size:.9rem}
    select{appearance:none;background:var(--bg-panel-2);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px 34px 8px 10px;font-size:.9rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.41 0.59L6 5.17 10.59 0.59 12 2 6 8 0 2 1.41 0.59Z' fill='%23a9b0bc'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
    .pill{background:var(--bg-panel-2);border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-weight:600}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:10px 0 14px}
    .kpi{background:var(--bg-panel);border-radius:var(--radius);padding:18px}
    .kpi h4{margin:0 0 8px;font-weight:600;color:var(--muted);font-size:0.95rem}
    .kpi .big{font-size:34px;font-weight:800;margin-bottom:10px}
    .kpi .sub{font-size:.9rem}
    .kpi .sub strong{color:var(--primary)}

    .chart{background:var(--bg-panel);border-radius:var(--radius);padding:16px}

    .grid-bottom{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}

    .panel{background:var(--bg-panel);border-radius:var(--radius);padding:18px}
    .panel h3{margin:0 0 12px;font-size:1.1rem}
    .status-item{margin:10px 0}
    .status-head{display:flex;justify-content:space-between;margin-bottom:6px;color:var(--muted);font-size:0.95rem}
    .bar{height:8px;background:var(--bg-panel-2);border-radius:4px;overflow:hidden}
    .bar-in{height:100%;background:var(--primary);border-radius:4px}

    @media(max-width:960px){.kpis{grid-template-columns:1fr 1fr}.controls{gap:12px}}
  </style>
</head>
<body>
  <div id="wrapper">
    <div class="header">
      <div>
        <h1 class="title" id="biz-name">—</h1>
        <div class="muted">Last updated on: <span id="last-updated">—</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span class="pill" id="agent-pill">Agent: All</span>
        <button id="refresh" class="btn">Refresh metrics</button>
      </div>
    </div>

    <div class="controls" id="controls">
      <div class="group"><span class="label">Range</span><select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select></div>
      <div class="group"><span class="label">Metric</span><select id="metric-select"></select></div>
      <div class="group"><span class="label">Agent</span><select id="agent-select"></select></div>
      <button id="show-all" class="btn">Show All</button>
      <div class="group"><span class="label">Chart</span><select id="chart-select">
        <option value="line">Line</option>
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="donut">Donut</option>
        <option value="funnel">Funnel</option>
      </select></div>
    </div>

    <div class="kpis" id="kpis">
      <!-- 4 KPI cards render here -->
    </div>

    <div class="chart"><div id="main-chart" style="min-height:360px"></div></div>

    <div class="grid-bottom">
      <div class="panel">
        <h3 id="pipeline-title">Pipeline Status</h3>
        <div id="pipeline-list"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== helpers
  const $ = s => document.querySelector(s);
  const fmt = n => new Intl.NumberFormat().format(Math.round(n||0));
  const pct = (a,b) => b>0 ? (100*a/b) : 0;
  const p1 = v => `${(v||0).toFixed(1)}%`;
  const VAR = { primary:getCS('--primary'), line:getCS('--line'), muted:getCS('--muted') };
  function getCS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  // ===== app state
  let DATA = {};
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'line' };
  let chartInstance = null;

  const METRICS = [
    {label:'Reply %', key:'replyPct', isPct:true, calc:(a)=>pct(a.Replies,a.Contacted), explain:(a)=>`Reply % = Replies / Contacted = ${fmt(a.Replies)} / ${fmt(a.Contacted)}`},
    {label:'Contacted → Appt/Lead %', key:'c2lPct', isPct:true, calc:(a)=>pct(a['Appointments / Leads'],a.Contacted), explain:(a)=>`Contacted → Appt/Lead % = Leads / Contacted = ${fmt(a['Appointments / Leads'])} / ${fmt(a.Contacted)}`},
    {label:'Appt/Lead → Close %', key:'l2cPct', isPct:true, calc:(a)=>pct(a.Sold,a['Appointments / Leads']), explain:(a)=>`Appt/Lead → Close % = Sold / Leads = ${fmt(a.Sold)} / ${fmt(a['Appointments / Leads'])}`},
    {label:'Contacted → Close %', key:'c2cPct', isPct:true, calc:(a)=>pct(a.Sold,a.Contacted), explain:(a)=>`Contacted → Close % = Sold / Contacted = ${fmt(a.Sold)} / ${fmt(a.Contacted)}`},
    {label:'Contacted', key:'Contacted', isPct:false, calc:(a)=>a.Contacted||0, explain:(a)=>`${fmt(a.Contacted)} contacted`},
    {label:'Replies', key:'Replies', isPct:false, calc:(a)=>a.Replies||0, explain:(a)=>`${fmt(a.Replies)} replies`},
    {label:'Appointments / Leads', key:'Appointments / Leads', isPct:false, calc:(a)=>a['Appointments / Leads']||0, explain:(a)=>`${fmt(a['Appointments / Leads'])} leads`},
    {label:'Sold', key:'Sold', isPct:false, calc:(a)=>a.Sold||0, explain:(a)=>`${fmt(a.Sold)} sold`}
  ];

  const PIPELINE_COLORS={"New":"#ED6C03","Lost":"#EF4444","Sold":"#22C55E","Needs Follow Up":"#F59E0B","Pipeline":"#8B5CF6","Finance":"#10B981","Service":"#3B82F6","Unchecked":"#94a3b8","default":"#6B7280"};

  // ===== data transforms
  const getAgents = (range)=> (DATA.agentsByRange?.[range]||[])
      .filter(a=>a.agent && a.agent.toLowerCase()!=='cxa')
      .map(a=>({
        name:a.agent,
        Contacted:a.outbound||0,
        Replies:a.inbound||0,
        ['Appointments / Leads']:a.leads||0,
        Sold:a.sold||0
      }));

  function withDerived(a){
    const base={...a};
    base.replyPct = pct(base.Replies, base.Contacted);
    base.c2lPct = pct(base['Appointments / Leads'], base.Contacted);
    base.l2cPct = pct(base.Sold, base['Appointments / Leads']);
    base.c2cPct = pct(base.Sold, base.Contacted);
    return base;
  }

  const totalOf = (arr)=> withDerived(arr.reduce((acc,x)=>{
    ['Contacted','Replies','Appointments / Leads','Sold'].forEach(k=>acc[k]=(acc[k]||0)+(x[k]||0));
    return acc;},{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0}));

  // ===== render header & kpis
  function renderHeader(){
    $('#biz-name').textContent = DATA.company || 'Performance Dashboard';
    const date = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = date.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
    $('#agent-pill').textContent = `Agent: ${state.agent}`;
  }

  function renderKPIs(){
    const agents = getAgents(state.range).map(withDerived);
    const scope = (state.agent==='All') ? totalOf(agents) : withDerived(agents.find(a=>a.name===state.agent)||{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0});

    const cards = [
      {title:'Prospects contacted', big:fmt(scope.Contacted), sub:''},
      {title:'Replies', big:fmt(scope.Replies), sub:`Reply %: <strong>${p1(scope.replyPct)}</strong>`},
      {title:'Appointments / Leads', big:fmt(scope['Appointments / Leads']), sub:`Contacted → Appt/Lead %: <strong>${p1(scope.c2lPct)}</strong>`},
      {title:'Closed', big:fmt(scope.Sold), sub:`Appt/Lead → Close %: <strong>${p1(scope.l2cPct)}</strong>`}
    ];
    $('#kpis').innerHTML = cards.map(c=>`<div class="kpi"><h4>${c.title}</h4><div class="big">${c.big}</div><div class="sub">${c.sub||''}</div></div>`).join('');
  }

  // ===== main chart
  function renderChart(){
    const agents = getAgents(state.range).map(withDerived);
    const metric = METRICS.find(m=>m.label===state.metric) || METRICS[0];

    // compute series + categories depending on mode
    let options;

    if(state.chart==='donut'){
      if(state.agent==='All'){
        const labels = agents.map(a=>a.name);
        const series = agents.map(a=> metric.isPct ? metric.calc(a) : a[metric.key]||0);
        options = donutOptions(series, labels, metric);
      }else{
        const a = withDerived(agents.find(x=>x.name===state.agent)||{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0});
        const labels=['Contacted','Replies','ApptLeads','Sold'];
        const series=[a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold];
        options = donutOptions(series, labels, metric);
      }
    }
    else if(state.chart==='funnel'){
      const target = (state.agent==='All') ? totalOf(agents) : withDerived(agents.find(a=>a.name===state.agent)||{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0});
      const labels=['Contacted','Replies','ApptLeads','Sold'];
      const values=[target.Contacted,target.Replies,target['Appointments / Leads'],target.Sold];
      options = funnelOptions(values, labels);
    }
    else{
      // bar/line (compare agents OR show a single agent breakdown)
      let categories, series;
      if(state.agent==='All'){
        categories = agents.map(a=>a.name);
        series = [{name:metric.label, data: agents.map(a=> metric.isPct ? metric.calc(a) : a[metric.key]||0)}];
      }else{
        const a = withDerived(agents.find(x=>x.name===state.agent)||{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0});
        categories=['Contacted','Replies','ApptLeads','Sold'];
        series=[{name:state.agent, data:[a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold]}];
      }
      options = baseXY(series, categories, metric, state.chart==='bar-h');
    }

    if(chartInstance) chartInstance.destroy();
    chartInstance = new ApexCharts(document.querySelector('#main-chart'), options);
    chartInstance.render();
  }

  function baseXY(series, categories, metric, horizontal){
    return {
      series,
      chart:{type: horizontal?'bar':(state.chart==='line'?'line':'bar'), height:360, toolbar:{show:false}, parentHeightOffset:0},
      plotOptions:{bar:{horizontal:!!horizontal,borderRadius:6,columnWidth:'55%'}},
      dataLabels:{enabled:false},
      stroke:{curve:'smooth',width:3},
      colors:[VAR.primary],
      grid:{borderColor:VAR.line,strokeDashArray:4},
      xaxis:{categories,labels:{style:{colors:VAR.muted}},axisBorder:{show:false},axisTicks:{show:false}},
      yaxis:{labels:{style:{colors:VAR.muted},formatter:(v)=> metric.isPct? `${Math.round(v)}%` : fmt(v)}},
      tooltip:{theme:'dark',y:{formatter:(val,opts)=>{
        if(state.agent==='All' && metric.isPct){
          const a = getAgents(state.range).map(withDerived)[opts.dataPointIndex];
          return `${p1(val)} — ${metric.explain(a)}`;
        }
        if(!metric.isPct) return fmt(val);
        // for single agent or pct compare
        const a = (state.agent==='All') ? getAgents(state.range).map(withDerived)[opts.dataPointIndex] : withDerived(
          (function(){
            const g=getAgents(state.range).find(x=>x.name===state.agent)||{Contacted:0,Replies:0,['Appointments / Leads']:0,Sold:0};
            return g;
          })());
        return `${p1(val)} — ${metric.explain(a)}`;
      }}}
    };
  }

  function donutOptions(series, labels, metric){
    return {
      series, labels,
      chart:{type:'donut', height:380, toolbar:{show:false}},
      dataLabels:{enabled:true, formatter:(v)=> `${v.toFixed(1)}%`},
      legend:{position:'right',labels:{colors:VAR.muted}},
      stroke:{width:1},
      plotOptions:{pie:{donut:{size:'55%'}}},
      colors: undefined,
      tooltip:{theme:'dark',y:{formatter:(val,opts)=>{
        const label = labels[opts.dataPointIndex];
        if(state.agent==='All' && metric.isPct){
          const a = withDerived(getAgents(state.range)[opts.dataPointIndex]);
          return `${p1(metric.calc(a))} — ${metric.explain(a)}`;
        }
        return fmt(val);
      }}}
    };
  }

  function funnelOptions(values, labels){
    // Render as horizontal bar descending = faux funnel
    const max = Math.max(1,...values);
    return {
      series:[{name:'Funnel', data: values}],
      chart:{type:'bar', height:360, toolbar:{show:false}},
      plotOptions:{bar:{horizontal:true,barHeight:'60%',distributed:true,borderRadius:8}},
      colors:['#60a5fa','#34d399','#fbbf24','#ef4444'],
      xaxis:{categories:labels,labels:{style:{colors:VAR.muted}},max:max,axisBorder:{show:false},axisTicks:{show:false}},
      grid:{borderColor:VAR.line,strokeDashArray:4},
      dataLabels:{enabled:true,style:{colors:['#0b0d12']},formatter:(val,opts)=>{
        const arr = values; const i=opts.dataPointIndex;
        if(i===0) return fmt(val);
        const stepPct = pct(arr[i], arr[i-1]);
        return `${fmt(val)} (${p1(stepPct)})`;
      }},
      tooltip:{theme:'dark',y:{formatter:(v,opts)=>{
        const i=opts.dataPointIndex; if(i===0) return `${fmt(v)} contacted`;
        const prev = values[i-1];
        return `${fmt(v)} — step conv ${p1(pct(v,prev))} = ${fmt(v)} / ${fmt(prev)}`;
      }}}
    };
  }

  // ===== pipeline status (filtered by agent)
  function renderPipeline(){
    const list = $('#pipeline-list');
    let statuses=[]; let total=0; let title='Pipeline Status';

    if(state.agent==='All'){
      statuses = (DATA.auditStatusTotals||[]);
      total = statuses.reduce((s,x)=>s+(x.Count||0),0);
    }else{
      const ap = (DATA.auditByAgent||[]).find(x=>x.agent===state.agent);
      statuses = ap? ap.totals : [];
      total = statuses.reduce((s,x)=>s+(x.Count||0),0);
      title += ` — ${state.agent}`;
    }

    $('#pipeline-title').textContent = title;
    list.innerHTML = statuses.map(s=>{
      const pctStr = p1(pct(s.Count,total));
      const color = PIPELINE_COLORS[s.Status] || PIPELINE_COLORS.default;
      return `<div class="status-item">
        <div class="status-head"><span>${s.Status}</span><span>${fmt(s.Count)} (${pctStr})</span></div>
        <div class="bar"><div class="bar-in" style="width:${pct(s.Count,total)}%;background:${color}"></div></div>
      </div>`;
    }).join('') + `<div class="status-item" style="margin-top:14px;color:var(--muted)">Total Contacts: ${fmt(total)}</div>`;
  }

  // ===== wiring
  function populateSelectors(){
    // metrics
    $('#metric-select').innerHTML = METRICS.map(m=>`<option value="${m.label}">${m.label}</option>`).join('');
    $('#metric-select').value = state.metric;
    // agents
    const names = ['All',...getAgents(state.range).map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option>${n}</option>`).join('');
    $('#agent-select').value = state.agent;
  }

  function onChange(){
    renderHeader(); renderKPIs(); renderChart(); renderPipeline(); sendHeight();
  }

  function wire(){
    $('#refresh').addEventListener('click',()=>location.reload());
    $('#range-select').addEventListener('change',e=>{state.range=e.target.value; populateSelectors(); onChange();});
    $('#metric-select').addEventListener('change',e=>{state.metric=e.target.value; onChange();});
    $('#agent-select').addEventListener('change',e=>{state.agent=e.target.value; $('#agent-pill').textContent=`Agent: ${state.agent}`; onChange();});
    $('#chart-select').addEventListener('change',e=>{state.chart=e.target.value; onChange();});
    $('#show-all').addEventListener('click',()=>{state.agent='All'; $('#agent-select').value='All'; $('#agent-pill').textContent='Agent: All'; onChange();});
    window.addEventListener('resize', sendHeight);
    window.addEventListener('message', (e)=>{
      const msg=e?.data; if(!msg||msg.type!=='VQ_METRICS') return; renderDashboard(msg.payload);
    });
  }

  function sendHeight(){ setTimeout(()=>{ parent.postMessage({type:'VQ_IFR_HEIGHT',height:document.body.scrollHeight},'*'); }, 0); }

  // ===== public entry
  window.renderDashboard = function(payload){
    try{
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      renderHeader(); populateSelectors(); renderKPIs(); renderChart(); renderPipeline(); sendHeight();
    }catch(err){ console.error('renderDashboard failed', err); }
  };

  // boot
  document.addEventListener('DOMContentLoaded', ()=>{ wire(); populateSelectors(); renderHeader(); sendHeight(); });
})();
</script>
</body>
</html>
