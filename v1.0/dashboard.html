<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard (GHL v1.6)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215;
      --line:#2b2f36; --text:#ffffff; --muted:#c9ced8; --primary:#ed6c03; --primary-dark:#b94f00;
      --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg-main); color:var(--text); margin:0; font-family:var(--font); height:auto; overflow:visible}

    /* ================= Loader (spinner + slow progress bar) ================= */
    body.loading .wrap{display:none;}
    body.loading #loader{display:grid;}
    #loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,17,21,.85); z-index:9999}
    .load-inner{display:flex; flex-direction:column; align-items:center; gap:14px; transform:translateY(-20px)}
    .spinner{width:88px; height:88px; border-radius:50%; background:radial-gradient(closest-side,rgba(237,108,3,.18),rgba(237,108,3,.04) 55%,transparent 60%);
      position:relative; box-shadow:0 0 60px rgba(237,108,3,.25)}
    .spinner:after{content:""; position:absolute; inset:10px; border-radius:50%; border:6px solid transparent; border-top-color:var(--primary);
      filter:drop-shadow(0 0 8px rgba(237,108,3,.9)); animation:spin 1s linear infinite}
    .progress-wrap{width:230px; height:8px; border-radius:999px; background:transparent; border:1px solid var(--line); overflow:hidden}
    .progress{height:100%; width:0%; background:linear-gradient(90deg, rgba(237,108,3,.95), rgba(237,108,3,.7)); box-shadow:0 0 16px rgba(237,108,3,.35); transition:width .6s ease}
    .load-text{color:#d9dde6; font-weight:700; letter-spacing:.2px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ================= Layout ================= */
    .wrap{width:100%; max-width:100%; margin:24px auto 80px; padding:0 16px}
    .section-title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .section-title h1{margin:0; font-size:20px; font-weight:800}
    .hint{color:var(--muted); font-size:.92rem}
    .pill{display:inline-flex; gap:8px; align-items:center; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text);
      border-radius:999px; padding:8px 12px; font-weight:700}
    .btn{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
    .btn:hover{background:var(--primary); border-color:var(--primary-dark)}
    .divider{height:1px; background:var(--line); margin:12px 0 18px}

    /* ================= Controls ================= */
    .controls{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; align-items:center;
      background:var(--bg-panel); border-radius:var(--radius); padding:12px; margin:8px 0 10px}
    .ctrl{grid-column:span 3; display:flex; flex-direction:column; gap:6px; min-width:0}
    .ctrl.small{grid-column:span 2}
    .label{color:var(--muted); font-size:.75rem; letter-spacing:.02em}
    select{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 14px; font-weight:600; width:100%}

    /* ================= Legend keys (tiny status dots) ================= */
    .keys{display:flex; align-items:center; flex-wrap:wrap; gap:14px; margin:2px 0 14px}
    .keys-label{color:var(--muted); font-size:.78rem; font-weight:800; margin-right:4px}
    .key-item{display:inline-flex; align-items:center; gap:6px; font-weight:700}
    .dot{width:10px; height:10px; border-radius:50%}

    /* ================= KPIs ================= */
    .grid-kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:8px 0 16px}
    .kpi{background:var(--bg-panel); border-radius:var(--radius); padding:18px; transition:box-shadow .25s}
    .kpi h4{margin:0 0 10px; color:var(--muted); font-weight:600; font-size:.95rem}
    .kpi .big{font-size:34px; font-weight:800; letter-spacing:.5px}
    .kpi .pillline{margin-top:8px; color:var(--muted)}
    .kpi .pillline strong{color:var(--primary)}
    .kpi.glow{box-shadow:0 0 0 2px var(--primary), 0 0 24px rgba(237,108,3,.35)}

    /* ================= Cards + chart headers ================= */
    .card{background:var(--bg-panel); border-radius:var(--radius); padding:14px}
    .section{background:var(--bg-panel); border-radius:var(--radius); padding:14px; margin-top:14px}
    .chart-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .chart-title{font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:8px}
    .chart-sub{color:var(--muted); font-size:.92rem}
    .chart-ctrls{display:flex; align-items:center; gap:10px}
    .info{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:50%;
      border:1px solid var(--line); color:#c9ced8; font-size:12px; cursor:help; opacity:.85}

    /* ================= Pipeline table ================= */
    .pipe-row{display:grid; grid-template-columns:1.5fr .7fr 3fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid var(--line)}
    .pipe-row:last-child{border-bottom:none}
    .bar{height:8px; background:var(--bg-panel-2); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; border-radius:999px}

    @media (max-width:980px){
      .grid-kpi{grid-template-columns:1fr 1fr}
      .ctrl{grid-column:span 6}
      .ctrl.small{grid-column:span 6}
      .chart-ctrls{flex-wrap:wrap}
    }
    @media (max-width:640px){
      .grid-kpi{grid-template-columns:1fr}
      .ctrl{grid-column:span 12}
      .ctrl.small{grid-column:span 12}
    }
  </style>
</head>
<body class="loading">
<div id="loader" aria-live="polite">
  <div class="load-inner">
    <div class="spinner" aria-hidden="true"></div>
    <div class="progress-wrap" aria-hidden="true"><div class="progress" id="progress-bar"></div></div>
    <div class="load-text" id="load-text">Fetching data…</div>
  </div>
</div>

<div class="wrap">
  <div class="section-title">
    <div>
      <h1 id="company">—</h1>
      <div class="hint">Last updated on: <span id="last-updated">—</span></div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <div class="pill" id="agent-pill" title="Which agent (or all) the metrics below reflect.">Agent: <strong id="agent-pill-name">All</strong></div>
      <div class="pill" id="metric-pill" title="Which metric is emphasized and shown on the main chart.">Metric: <strong id="metric-pill-name">Reply %</strong></div>
      <div class="pill" id="range-pill" title="Time window used to compute metrics.">Range: <strong id="range-pill-name">Last 24 Hours</strong></div>
      <button class="btn" id="refresh-btn" title="Reload everything from the source.">Refresh metrics</button>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Controls now: Range / Agent / Quick -->
  <div class="controls" id="controls">
    <div class="ctrl small">
      <div class="label">Range</div>
      <select id="range-select" aria-label="Select range">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="ctrl small">
      <div class="label">Agent</div>
      <select id="agent-select" aria-label="Select agent"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Quick</div>
      <button class="btn" id="show-all" title="Reset to show all agents.">Show All</button>
    </div>
  </div>

  <!-- Tiny legend (agents + range) -->
  <div class="keys" id="keys-row"></div>

  <!-- KPIs -->
  <div class="grid-kpi">
    <div class="kpi" id="kpi-contacted-card" title="Total outbound contacts made in the selected range."><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div></div>
    <div class="kpi" id="kpi-replies-card" title="Total replies received in the selected range."><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="pillline">Reply %: <strong id="kpi-replyPct">0%</strong></div></div>
    <div class="kpi" id="kpi-leads-card" title="Appointments or leads created in the selected range."><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="pillline">Contacted → Appt/Lead %: <strong id="kpi-c2l">0%</strong></div></div>
    <div class="kpi" id="kpi-sold-card" title="Closed deals during the selected range."><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="pillline">Appt/Lead → Close %: <strong id="kpi-l2c">0%</strong></div></div>
  </div>

  <!-- TOP: Agent performance -->
  <div class="card" id="chart-card" aria-label="Agent performance section">
    <div class="chart-header">
      <div>
        <div class="chart-title" id="main-chart-title">—</div>
        <div class="chart-sub" id="main-chart-sub">—</div>
      </div>
      <div class="chart-ctrls">
        <span class="info" title="Pick the metric shown on this chart and highlighted in KPIs.">i</span>
        <div class="label">Metric</div>
        <select id="metric-select-top" aria-label="Select metric"></select>
        <span class="info" title="Change the visualization for this chart.">i</span>
        <div class="label">View as</div>
        <select id="chart-select-top" aria-label="Select chart type">
          <option value="funnel">Funnel</option>
          <option value="bar">Bar (vertical)</option>
          <option value="bar-h">Bar (horizontal)</option>
          <option value="donut">Donut</option>
          <option value="line">Line</option>
        </select>
      </div>
    </div>
    <div id="main-chart"></div>
  </div>

  <!-- Divider: Agent vs Sales -->
  <div class="divider" title="Agent performance (above) vs Sales pipeline performance (below)"></div>

  <!-- BOTTOM: Sales pipeline performance -->
  <div class="section" aria-label="Sales pipeline section">
    <div class="chart-header" style="margin-bottom:8px">
      <div>
        <div class="chart-title" id="pipe-title">Sales pipeline performance</div>
        <div class="chart-sub" id="pipe-sub">—</div>
      </div>
      <div class="chart-ctrls">
        <span class="info" title="Select how to display the pipeline distribution.">i</span>
        <div class="label">View as</div>
        <select id="pipe-view" aria-label="Select pipeline view">
          <option value="table">Table</option>
          <option value="bars">Horizontal bars</option>
          <option value="donut">Donut</option>
          <option value="line">Line</option>
        </select>
      </div>
    </div>
    <div id="pipeline-table"></div>
    <div id="pipeline-chart" style="display:none"></div>
    <div class="hint" id="pipe-total" style="margin-top:8px"></div>
  </div>
</div>

<script>
(function(){
  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const fmtInt = n => new Intl.NumberFormat().format(Math.round(Number(n)||0));
  const fmt2 = n => { const v = Number(n)||0; return Math.abs(v - Math.round(v)) < 0.005 ? fmtInt(v) : v.toFixed(2); };
  const safeDiv = (a,b) => (b>0 ? (Number(a)||0)/(Number(b)||0) : 0);
  const pct = (num, den) => 100*safeDiv(num, den);
  const nicePct = v => `${Math.round(Number(v)||0)}%`;
  const LINE = getComputedStyle(document.documentElement).getPropertyValue('--line').trim();
  const rangeLabel = r => ({'24h':'Last 24 Hours','7d':'Last 7 Days','30d':'Last 30 Days','90d':'Last 90 Days'})[r]||r;
  const chartLabel = c => ({'funnel':'Funnel','bar':'Bar (vertical)','bar-h':'Bar (horizontal)','donut':'Donut','line':'Line'})[c]||c;

  // stable agent palette via hash → index
  const PALETTE = ['#ed6c03','#22c55e','#8b5cf6','#3b82f6','#14b8a6','#ef4444','#eab308','#a855f7'];
  const agentColor = name => { if(!name) return '#6B7280'; let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; return PALETTE[h%PALETTE.length]; };

  const RANGE_COLORS = {'24h':'#ed6c03','7d':'#14b8a6','30d':'#3b82f6','90d':'#8b5cf6'};
  const METRIC_ACCENTS = {
    'Reply %':'#ed6c03',
    'Contacted → Appt/Lead %':'#8b5cf6',
    'Appt/Lead → Close %':'#22c55e',
    'Contacted':'#3b82f6',
    'Replies':'#ed6c03',
    'Appointments / Leads':'#8b5cf6',
    'Sold':'#22c55e'
  };

  let DATA = {};
  let mainChart = null, pipeChart = null;
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'funnel', pipeView:'table' };

  const METRICS = [
    { label:'Reply %', key:'Reply %', pct:true },
    { label:'Contacted → Appt/Lead %', key:'Contacted → Appt/Lead %', pct:true },
    { label:'Appt/Lead → Close %', key:'Appt/Lead → Close %', pct:true },
    { label:'Contacted', key:'Contacted' },
    { label:'Replies', key:'Replies' },
    { label:'Appointments / Leads', key:'Appointments / Leads' },
    { label:'Sold', key:'Sold' }
  ];

  const getAgents = () => (DATA.agentsByRange?.[state.range]||[])
    .filter(a => a.agent && a.agent.toLowerCase()!=='cxa')
    .map(a => ({ name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0 }));

  const totalsOf = (arr) => arr.reduce((acc,c)=>{
    Object.keys(c).forEach(k=>{ if(k!=='name') acc[k]=(acc[k]||0)+(Number(c[k])||0); });
    return acc;
  },{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  const addDerived = (o) => ({
    ...o,
    'Reply %': pct(o.Replies, o.Contacted),
    'Contacted → Appt/Lead %': pct(o['Appointments / Leads'], o.Contacted),
    'Appt/Lead → Close %': pct(o.Sold, o['Appointments / Leads'])
  });

  // ===== UI color accents =====
  function setMetricAccent(){
    const color = METRIC_ACCENTS[state.metric] || '#ed6c03';
    const metricPill = $('#metric-pill');
    $('#metric-pill-name').textContent = state.metric;
    metricPill.style.borderColor = color;
    metricPill.style.boxShadow = `0 0 0 2px ${color} inset, 0 0 18px ${hexToRgba(color,.35)}`;

    // KPI glow rules
    ['kpi-contacted-card','kpi-replies-card','kpi-leads-card','kpi-sold-card'].forEach(id=>$('#'+id).classList.remove('glow'));
    if(state.metric==='Contacted') $('#kpi-contacted-card').classList.add('glow');
    if(state.metric==='Replies' || state.metric==='Reply %') { $('#kpi-replies-card').classList.add('glow'); if(state.metric==='Reply %') $('#kpi-contacted-card').classList.add('glow'); }
    if(state.metric==='Appointments / Leads') $('#kpi-leads-card').classList.add('glow');
    if(state.metric==='Contacted → Appt/Lead %') { $('#kpi-contacted-card').classList.add('glow'); $('#kpi-leads-card').classList.add('glow'); }
    if(state.metric==='Appt/Lead → Close %') { $('#kpi-leads-card').classList.add('glow'); $('#kpi-sold-card').classList.add('glow'); }
    if(state.metric==='Sold') $('#kpi-sold-card').classList.add('glow');
  }
  function setRangeAccent(){
    const color = RANGE_COLORS[state.range] || '#6B7280';
    const pill = $('#range-pill');
    $('#range-pill-name').textContent = rangeLabel(state.range);
    pill.style.borderColor = color;
    pill.style.boxShadow = `0 0 0 2px ${color} inset`;
  }
  function setAgentPill(){
    $('#agent-pill-name').textContent = state.agent;
    const pill = $('#agent-pill');
    pill.style.borderColor = state.agent==='All' ? 'var(--line)' : agentColor(state.agent);
    pill.style.boxShadow = state.agent==='All' ? 'none' : `0 0 0 2px ${agentColor(state.agent)} inset`;
  }
  function hexToRgba(hex,a){ const v=hex.replace('#',''); const r=parseInt(v.slice(0,2),16), g=parseInt(v.slice(2,4),16), b=parseInt(v.slice(4,6),16); return `rgba(${r},${g},${b},${a||1})`; }

  // ===== Legend (tiny dots) =====
  function renderKeys(){
    const el = $('#keys-row');
    const items = [];
    items.push(`<span class="keys-label">Agents</span>`);
    const list = state.agent==='All' ? getAgents().map(a=>a.name) : [state.agent];
    for(const name of list){
      items.push(`<span class="key-item"><span class="dot" style="background:${agentColor(name)}"></span>${name}</span>`);
    }
    items.push(`<span class="key-item"><span class="dot" style="background:${RANGE_COLORS[state.range]||'#6B7280'}"></span>${rangeLabel(state.range)}</span>`);
    el.innerHTML = items.join('');
  }

  // ===== Populate & KPIs =====
  function populateSelectors(){
    // top metric/chart selects
    $('#metric-select-top').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    $('#metric-select-top').value = state.metric;
    $('#chart-select-top').value = state.chart;

    const names = ['All', ...getAgents().map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
    $('#agent-select').value = state.agent;
    $('#range-select').value = state.range;

    setMetricAccent(); setRangeAccent(); setAgentPill(); renderKeys();
  }

  function renderHeaderKPIs(){
    $('#company').textContent = DATA.company || 'Performance';
    const date = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = date.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

    const base = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent) || {Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
    const d = addDerived(base);
    $('#kpi-contacted').textContent = fmtInt(base.Contacted);
    $('#kpi-replies').textContent = fmtInt(base.Replies);
    $('#kpi-leads').textContent = fmtInt(base['Appointments / Leads']);
    $('#kpi-sold').textContent = fmtInt(base.Sold);
    $('#kpi-replyPct').textContent = nicePct(d['Reply %']);
    $('#kpi-c2l').textContent = nicePct(d['Contacted → Appt/Lead %']);
    $('#kpi-l2c').textContent = nicePct(d['Appt/Lead → Close %']);
  }

  function describeMain(){
    const title = (state.agent==='All')
      ? `Agent performance — ${state.metric}`
      : `<span class="dot" style="background:${agentColor(state.agent)}"></span>${state.agent} — ${state.metric}`;
    const sub = `Range: ${rangeLabel(state.range)} · Chart: ${chartLabel(state.chart)}`;
    $('#main-chart-title').innerHTML = title; $('#main-chart-sub').textContent = sub;
  }
  function describePipe(){
    const title = (state.agent==='All')
      ? 'Sales pipeline performance — all agents'
      : `Sales pipeline performance — <span class="dot" style="background:${agentColor(state.agent)}"></span>${state.agent}`;
    $('#pipe-title').innerHTML = title;
    $('#pipe-sub').textContent = `Distribution of contact statuses · ${state.agent==='All'? 'All agents' : state.agent}`;
  }

  // ===== Charts =====
  function renderMainChart(){
    describeMain();
    const agents = getAgents().map(addDerived);
    const selectedMetric = METRICS.find(m=>m.label===state.metric);

    let cats=[], dataVals=[];
    if(state.agent==='All'){
      cats = agents.map(a=>a.name);
      dataVals = agents.map(a=>Number(a[selectedMetric.key])||0);
    }else{
      const a = agents.find(x=>x.name===state.agent) || null;
      cats = ['Contacted','Replies','Appt/Leads','Sold'];
      dataVals = a ? [a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold].map(v=>Number(v)||0) : [0,0,0,0];
    }

    const isPct = !!selectedMetric?.pct;
    const accent = state.agent==='All' ? (METRIC_ACCENTS[state.metric]||'#ed6c03') : agentColor(state.agent);
    const usableType = (state.chart==='line' && (dataVals.filter(v=>v>0).length<2 || cats.length<2)) ? 'funnel' : state.chart;

    const baseOpts = {
      chart:{ toolbar:{show:false}, parentHeightOffset:0, foreColor:'#c9ced8', dropShadow:{enabled:true, blur:2, opacity:0.18} },
      grid:{borderColor:LINE, strokeDashArray:4},
      tooltip:{theme:'dark', y:{formatter:(val)=> isPct ? `${Math.round(Number(val)||0)}%` : fmt2(val)}},
      legend:{labels:{colors:'#c9ced8'}},
      xaxis:{ labels:{ style:{colors:'#c9ced8'}, rotate:0, trim:true }, title:{text: state.agent==='All'?'Agents':'Stages', style:{color:'#c9ced8'}} },
      yaxis:{ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> isPct ? `${Math.round(v)}%` : fmt2(v) }, min:0, title:{ text: isPct ? 'Percent' : 'Count', style:{color:'#c9ced8'} } }
    };

    let opts = {...baseOpts};

    if(usableType==='funnel'){
      const b = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent)||{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
      const seriesData = [
        {x:'Contacted', y:Number(b.Contacted)||0},
        {x:'Replies', y:Number(b.Replies)||0},
        {x:'Appt/Leads', y:Number(b['Appointments / Leads'])||0},
        {x:'Sold', y:Number(b.Sold)||0}
      ];
      opts.colors=[accent];
      opts.chart.type='bar';
      opts.plotOptions={bar:{horizontal:true, borderRadius:6, barHeight:'40%', dataLabels:{position:'center'}}};
      opts.dataLabels={enabled:true, style:{fontWeight:700}, formatter:(v,{dataPointIndex})=> fmt2(seriesData[dataPointIndex].y)};
      opts.series=[{name:state.metric, data:seriesData}];
      // Force counts for funnel to avoid NaN% labels
      opts.yaxis={ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> fmt2(v) }, min:0, title:{ text:'Count', style:{color:'#c9ced8'} } };
      opts.xaxis={...opts.xaxis, title:{text:'Stages', style:{color:'#c9ced8'}}, labels:{style:{colors:'#c9ced8'}}};
    } else if(usableType==='donut'){
      const sum = dataVals.reduce((a,b)=>a+(Number(b)||0),0);
      let series = dataVals.map(v=>Math.max(0, Number(v)||0));
      let labels = cats.length?cats:[state.metric];
      let colors = (state.agent==='All') ? cats.map(n=>agentColor(n)) : series.map(()=>accent);
      if(sum<=0){ series=[1]; labels=['No data']; colors=['#2b2f36']; }

      opts = {
        ...baseOpts,
        chart:{...baseOpts.chart, type:'donut'},
        series, labels, colors,
        stroke:{show:true, width:0},
        dataLabels:{enabled: sum>0, formatter:(val)=> `${Math.round(val)}%`, style:{fontSize:'12px', fontWeight:700}},
        legend:{position:'right', labels:{colors:'#c9ced8'}},
        fill:{ type:'gradient', gradient:{ shade:'dark', type:'vertical', shadeIntensity:0.5, gradientToColors:colors.map(c=>lighten(c,.15)), opacityFrom:0.95, opacityTo:0.85, stops:[0,50,100]} },
        plotOptions:{ pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label: sum>0?'Total':'No data', formatter:(w)=> sum>0? fmtInt(series.reduce((a,b)=>a+b,0)) : '' } } } } }
      };
    } else if(usableType==='bar-h'){
      const distributed = (state.agent==='All');
      const colors = distributed ? cats.map(n=>agentColor(n)) : [accent];
      opts.colors = colors;
      opts.chart.type='bar';
      opts.plotOptions={bar:{horizontal:true, borderRadius:6, distributed, dataLabels:{position:'center'}}};
      opts.xaxis={...opts.xaxis, categories:cats, title:{text: state.agent==='All'?'Agents':'Stages', style:{color:'#c9ced8'}}};
      opts.dataLabels={enabled:true, style:{fontWeight:700}, formatter:(v)=> isPct? `${Math.round(v)}%` : fmt2(v)};
      opts.yaxis={ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> isPct ? `${Math.round(v)}%` : fmt2(v) }, min:0, title:{text: isPct?'Percent':'Count', style:{color:'#c9ced8'}}};
    } else if(usableType==='bar'){
      const distributed = (state.agent==='All');
      const colors = distributed ? cats.map(n=>agentColor(n)) : [accent];
      opts.colors = colors;
      opts.chart.type='bar';
      opts.plotOptions={bar:{horizontal:false, borderRadius:6, columnWidth:'55%', distributed, dataLabels:{position:'top'}}};
      opts.dataLabels={enabled:true, offsetY:-8, style:{fontWeight:700}, formatter:(v)=> isPct? `${Math.round(v)}%` : fmt2(v)};
      opts.xaxis={...opts.xaxis, categories:cats, title:{text: state.agent==='All'?'Agents':'Stages', style:{color:'#c9ced8'}}};
      opts.yaxis={ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> isPct ? `${Math.round(v)}%` : fmt2(v) }, min:0, title:{text: isPct?'Percent':'Count', style:{color:'#c9ced8'}}};
      opts.series=[{name:state.metric, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else { // line
      const color = accent;
      opts.colors=[color];
      opts.chart.type='line'; opts.stroke={curve:'smooth', width:3}; opts.markers={size:3};
      opts.xaxis={...opts.xaxis, categories:cats, title:{text: state.agent==='All'?'Agents':'Stages', style:{color:'#c9ced8'}}};
      opts.yaxis={ labels:{ style:{colors:'#c9ced8'}, formatter:(v)=> isPct ? `${Math.round(v)}%` : fmt2(v) }, min:0, title:{text: isPct?'Percent':'Count', style:{color:'#c9ced8'}}};
      opts.series=[{name:(state.agent==='All'?state.metric:state.agent), data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    }

    if(mainChart) mainChart.destroy();
    mainChart = new ApexCharts($('#main-chart'), {...opts, chart:{...opts.chart, height:460}});
    mainChart.render();
  }

  function lighten(hex, amt){
    const v = hex.replace('#',''); const r = Math.min(255, parseInt(v.substr(0,2),16)+Math.round(255*amt));
    const g = Math.min(255, parseInt(v.substr(2,2),16)+Math.round(255*amt));
    const b = Math.min(255, parseInt(v.substr(4,2),16)+Math.round(255*amt));
    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
  }

  function getPipeTotals(){
    if(state.agent==='All') return (DATA.auditStatusTotals||[]);
    const agentBlock = (DATA.auditByAgent||[]).find(a=>a.agent===state.agent);
    return agentBlock ? agentBlock.totals || [] : [];
  }

  function renderPipeline(){
    describePipe();
    const rows = getPipeTotals();
    const total = rows.reduce((s,r)=>s+(Number(r.Count)||0),0);
    $('#pipe-total').textContent = `Total Contacts: ${fmtInt(total)}`;

    const view = state.pipeView;
    $('#pipeline-table').style.display = view==='table'? 'block':'none';
    $('#pipeline-chart').style.display = view==='table'? 'none':'block';

    if(view==='table'){
      const html = rows.map(r=>{
        const count = Number(r.Count)||0;
        const p = pct(count, total);
        const color = agentColor(r.Status);
        return `<div class="pipe-row">
          <div><span class="dot" style="background:${color}"></span>${r.Status}</div>
          <div style="text-align:right">${fmtInt(count)} (${Math.round(p)}%)</div>
          <div class="bar"><span style="width:${Math.max(0,p)}%; background:${color}"></span></div>
        </div>`;
      }).join('');
      $('#pipeline-table').innerHTML = html || '<div class="hint">No data.</div>';
    } else {
      const series = rows.map(r=>Math.max(0,(Number(r.Count)||0)));
      const labels = rows.map(r=>r.Status);
      const colors = labels.map(l=>agentColor(l));
      const h = Math.max(420, Math.min(560, 150 + labels.length*28));

      const base = { chart:{toolbar:{show:false}, parentHeightOffset:0, foreColor:'#c9ced8', dropShadow:{enabled:true, blur:2, opacity:.18}}, labels, colors, tooltip:{theme:'dark'}, legend:{labels:{colors:'#c9ced8'}} };

      if(view==='bars'){
        const opts = { ...base, chart:{...base.chart, type:'bar'},
          grid:{borderColor:LINE, strokeDashArray:4},
          plotOptions:{bar:{horizontal:true, borderRadius:6, dataLabels:{position:'center'}}},
          xaxis:{categories:labels, title:{text:'Status', style:{color:'#c9ced8'}}},
          yaxis:{title:{text:'Count', style:{color:'#c9ced8'}}},
          dataLabels:{enabled:true, style:{fontWeight:700}, formatter:(v)=>fmt2(v)},
          series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      } else if(view==='donut'){
        const sum = series.reduce((a,b)=>a+b,0);
        const opts = { ...base, chart:{...base.chart, type:'donut'}, grid:{borderColor:LINE, strokeDashArray:4},
          series: (sum>0?series:[1]), labels: (sum>0?labels:['No data']), colors: (sum>0?colors:['#2b2f36']), stroke:{show:true, width:0},
          dataLabels:{enabled: sum>0, formatter:(v)=>`${Math.round(v)}%`},
          plotOptions:{ pie:{ donut:{ size:'68%', labels:{ show:true, total:{ show:true, label: sum>0? 'Total':'No data', formatter:(w)=> sum>0? fmtInt(sum) : '' } } } } },
          legend:{position:'right', labels:{colors:'#c9ced8'}} };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      } else { // line
        const opts = { ...base, colors:['#ed6c03'], chart:{...base.chart, type:'line'},
          grid:{borderColor:LINE, strokeDashArray:4},
          stroke:{curve:'smooth', width:3}, markers:{size:3},
          xaxis:{categories:labels, title:{text:'Status', style:{color:'#c9ced8'}}},
          yaxis:{ labels:{ formatter:(v)=>fmt2(v) }, title:{text:'Count', style:{color:'#c9ced8'}} },
          series:[{name:'Count', data:series}] };
        if(pipeChart) pipeChart.destroy(); pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:h}}); pipeChart.render();
      }
    }
  }

  // ===== Loader control (slow bar + fast finish) =====
  let progRAF = null, progStart = null, progHold = 0;
  function startProgress(){
    const bar = $('#progress-bar');
    progStart = performance.now();
    progHold = 0;
    cancelAnimationFrame(progRAF);
    const targetSlow = 85; // creep to ~85% in ~30s
    const duration = 30000;

    const step = (t)=>{
      const elapsed = Math.max(0, t - progStart);
      const p = Math.min(targetSlow, (elapsed/duration)*targetSlow);
      progHold = p;
      bar.style.width = p.toFixed(2)+'%';
      progRAF = requestAnimationFrame(step);
    };
    progRAF = requestAnimationFrame(step);
  }
  function finishProgress(){
    cancelAnimationFrame(progRAF);
    $('#progress-bar').style.width = '100%';
    // small delay so 100% is visible
    setTimeout(()=>{ document.body.classList.remove('loading'); $('#progress-bar').style.width='0%'; }, 450);
  }
  const showLoader = (flag)=>{ document.body.classList.toggle('loading', !!flag); if(flag) startProgress(); };

  // ===== infra =====
  function wire(){
    $('#range-select').addEventListener('change', e=>{ state.range=e.target.value; setRangeAccent(); renderKeys(); refreshAll(); });
    $('#agent-select').addEventListener('change', e=>{ state.agent=e.target.value; setAgentPill(); renderKeys(); refreshAll(); });

    // top chart controls
    $('#metric-select-top').addEventListener('change', e=>{ state.metric=e.target.value; setMetricAccent(); refreshChartsOnly(); });
    $('#chart-select-top').addEventListener('change', e=>{ state.chart=e.target.value; renderMainChart(); sendHeight(); });

    $('#pipe-view').addEventListener('change', e=>{ state.pipeView=e.target.value; renderPipeline(); sendHeight(); });

    $('#show-all').addEventListener('click', ()=>{ state.agent='All'; $('#agent-select').value='All'; setAgentPill(); renderKeys(); refreshAll(); });
    $('#refresh-btn').addEventListener('click', ()=> window.location.reload());

    window.addEventListener('resize', ()=> sendHeight());
    window.addEventListener('message', (e)=>{ const m=e?.data; if(!m) return; if(m.type==='VQ_METRICS'){ renderDashboard(m.payload); } if(m.type==='VQ_REQUEST_HEIGHT'){ sendHeight(); }});
  }

  function refreshAll(){ renderHeaderKPIs(); renderMainChart(); renderPipeline(); sendHeight(); }
  function refreshChartsOnly(){ renderMainChart(); renderPipeline(); sendHeight(); }

  function computedHeight(){
    return Math.max(
      document.body.scrollHeight, document.documentElement.scrollHeight,
      document.body.offsetHeight, document.documentElement.offsetHeight,
      document.body.clientHeight, document.documentElement.clientHeight
    );
  }
  function sendHeight(){ setTimeout(()=>{ parent.postMessage({type:'VQ_IFR_HEIGHT', height: computedHeight() }, '*'); }, 0); }
  const ro = new ResizeObserver(()=> sendHeight()); ro.observe(document.documentElement);

  // public entry
  window.renderDashboard = function(payload){
    try{
      showLoader(true);
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      state.range = state.range || '24h'; state.chart = state.chart || 'funnel'; state.metric = state.metric || 'Reply %'; state.agent = state.agent || 'All';
      populateSelectors(); refreshAll();
    }catch(err){ console.error('renderDashboard failed', err); }
    finally{ finishProgress(); } // fast-finish once data lands
  };

  document.addEventListener('DOMContentLoaded', ()=>{ showLoader(true); populateSelectors(); wire(); sendHeight(); });
})();
</script>
</body>
</html>
