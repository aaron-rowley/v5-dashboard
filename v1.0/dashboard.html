<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Performance Dashboard (v1.1)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg-main:#0f1115; --bg-panel:#17191e; --bg-panel-2:#21242b; --bg-element:#101215;
      --line:#2b2f36; --text:#ffffff; --muted:#a9b0bc; --primary:#ed6c03; --primary-dark:#b94f00;
      --radius:12px; --font:'Outfit',sans-serif; --shadow:0 8px 32px rgba(0,0,0,.25);
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --violet:#8b5cf6; --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg-main); color:var(--text); margin:0; font-family:var(--font);}
    /* let the widget expand fully (no inner scrollbars) */
    body{overflow:visible}

    .wrap{max-width:1200px; margin:24px auto 80px; padding:0 16px}

    .controls{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; align-items:center;
      background:var(--bg-panel); border-radius:var(--radius); padding:12px; margin:8px 0 16px}
    .ctrl{grid-column:span 3; display:flex; flex-direction:column; gap:6px}
    .ctrl.small{grid-column:span 2}
    .label{color:var(--muted); font-size:.75rem; letter-spacing:.02em}
    select,.pill,button.btn{appearance:none; background:var(--bg-panel-2); border:1px solid var(--line);
      color:var(--text); border-radius:10px; padding:10px 14px; font-weight:600}
    .pill{display:inline-flex; gap:6px; align-items:center}
    .btn{cursor:pointer}
    .btn:hover{background:var(--primary); border-color:var(--primary-dark)}

    .grid-kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:8px 0 16px}
    .kpi{background:var(--bg-panel); border-radius:var(--radius); padding:18px}
    .kpi h4{margin:0 0 10px; color:var(--muted); font-weight:600; font-size:.95rem}
    .kpi .big{font-size:34px; font-weight:800; letter-spacing:.5px}
    .kpi .pillline{margin-top:8px; color:var(--muted)}
    .kpi .pillline strong{color:var(--primary)}

    .card{background:var(--bg-panel); border-radius:var(--radius); padding:14px}

    .divider{height:1px; background:var(--line); margin:18px 0}

    .section-title{display:flex; align-items:center; justify-content:space-between; margin:6px 2px 10px}
    .section-title h3{margin:0; font-size:1rem}
    .hint{color:var(--muted); font-size:.9rem}

    /* Pipeline table */
    .pipe-table{width:100%; border-collapse:collapse}
    .pipe-table td{padding:10px 6px; border-bottom:1px solid var(--line); font-size:.95rem}
    .pipe-row{display:grid; grid-template-columns:1.5fr .6fr 3fr; gap:10px; align-items:center}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px}
    .bar{height:8px; background:var(--bg-panel-2); border-radius:6px; overflow:hidden}
    .bar>span{display:block; height:100%; background:var(--primary); border-radius:6px}

    /* Loader (circular glow only) */
    #loader{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,17,21,.6); z-index:9999}
    .spinner{width:84px; height:84px; border-radius:50%; background:radial-gradient(closest-side,rgba(237,108,3,.18),rgba(237,108,3,.04) 55%,transparent 60%);
      position:relative; box-shadow:0 0 60px rgba(237,108,3,.25)}
    .spinner:after{content:""; position:absolute; inset:10px; border-radius:50%; border:6px solid transparent; border-top-color:var(--primary);
      filter:drop-shadow(0 0 8px rgba(237,108,3,.9)); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* responsive */
    @media (max-width:980px){
      .grid-kpi{grid-template-columns:1fr 1fr}
      .ctrl{grid-column:span 6}
      .ctrl.small{grid-column:span 6}
    }
    @media (max-width:640px){
      .grid-kpi{grid-template-columns:1fr}
      .ctrl{grid-column:span 12}
      .ctrl.small{grid-column:span 12}
    }
  </style>
</head>
<body>
<div id="loader"><div class="spinner"></div></div>
<div class="wrap">
  <div class="section-title">
    <div>
      <div id="company" style="font-size:20px; font-weight:800">—</div>
      <div class="hint">Last updated on: <span id="last-updated">—</span></div>
    </div>
    <div class="pill" id="agent-pill">Agent: <strong id="agent-pill-name">All</strong></div>
  </div>

  <div class="controls" id="controls">
    <div class="ctrl small">
      <div class="label">Range</div>
      <select id="range-select">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>
    <div class="ctrl small">
      <div class="label">Metric</div>
      <select id="metric-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Agent</div>
      <select id="agent-select"></select>
    </div>
    <div class="ctrl small">
      <div class="label">Quick</div>
      <button class="btn" id="show-all">Show All</button>
    </div>
    <div class="ctrl small">
      <div class="label">Chart</div>
      <select id="chart-select">
        <option value="funnel">Funnel</option>
        <option value="bar">Bar (vertical)</option>
        <option value="bar-h">Bar (horizontal)</option>
        <option value="donut">Donut</option>
        <option value="line">Line</option>
      </select>
    </div>
  </div>

  <div class="grid-kpi">
    <div class="kpi"><h4>Prospects contacted</h4><div class="big" id="kpi-contacted">0</div></div>
    <div class="kpi"><h4>Replies</h4><div class="big" id="kpi-replies">0</div><div class="pillline">Reply %: <strong id="kpi-replyPct">0.0%</strong></div></div>
    <div class="kpi"><h4>Appointments / Leads</h4><div class="big" id="kpi-leads">0</div><div class="pillline">Contacted → Appt/Lead %: <strong id="kpi-c2l">0.0%</strong></div></div>
    <div class="kpi"><h4>Closed</h4><div class="big" id="kpi-sold">0</div><div class="pillline">Appt/Lead → Close %: <strong id="kpi-l2c">0.0%</strong></div></div>
  </div>

  <div class="card" id="chart-card">
    <div id="main-chart"></div>
  </div>

  <div class="divider"></div>

  <div class="card">
    <div class="section-title">
      <h3 id="pipe-title">Pipeline Status</h3>
      <div style="display:flex; align-items:center; gap:10px">
        <span class="label">View as</span>
        <select id="pipe-view">
          <option value="table">Table</option>
          <option value="bars">Horizontal bars</option>
          <option value="donut">Donut</option>
        </select>
      </div>
    </div>
    <div id="pipeline-table"></div>
    <div id="pipeline-chart" style="display:none"></div>
    <div class="hint" id="pipe-total" style="margin-top:8px"></div>
  </div>
</div>

<script>
(function(){
  // helpers
  const $ = s => document.querySelector(s);
  const fmt = n => new Intl.NumberFormat().format(Math.round(n||0));
  const safeDiv = (a,b) => (b>0 ? a/b : 0);
  const pct = (num, den) => 100*safeDiv(num, den);
  const nicePct = v => `${(v||0).toFixed(1)}%`;
  const COLORS = {
    New:'#ED6C03', Lost:'#EF4444', Sold:'#22C55E', 'Needs Follow Up':'#F59E0B',
    Pipeline:'#8B5CF6', 'sold b/ai':'#3B82F6', Unchecked:'#60a5fa', Service:'#10b981',
    default:'#6B7280'
  };

  let DATA = {}; // payload
  let mainChart = null, pipeChart = null;
  const state = { range:'24h', metric:'Reply %', agent:'All', chart:'funnel', pipeView:'table' };

  const METRICS = [
    { label:'Reply %', key:'Reply %', pct:true },
    { label:'Contacted → Appt/Lead %', key:'Contacted → Appt/Lead %', pct:true },
    { label:'Appt/Lead → Close %', key:'Appt/Lead → Close %', pct:true },
    { label:'Contacted', key:'Contacted' },
    { label:'Replies', key:'Replies' },
    { label:'Appointments / Leads', key:'Appointments / Leads' },
    { label:'Sold', key:'Sold' }
  ];

  // data adapters
  const getAgents = () => (DATA.agentsByRange?.[state.range]||[])
    .filter(a => a.agent && a.agent.toLowerCase()!=='cxa')
    .map(a => ({ name:a.agent, Contacted:a.outbound||0, Replies:a.inbound||0, 'Appointments / Leads':a.leads||0, Sold:a.sold||0 }));

  const totalsOf = (arr) => arr.reduce((acc,c)=>{
    Object.keys(c).forEach(k=>{ if(k!=='name') acc[k]=(acc[k]||0)+(c[k]||0); });
    return acc;
  },{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});

  const addDerived = (o) => ({
    ...o,
    'Reply %': pct(o.Replies, o.Contacted),
    'Contacted → Appt/Lead %': pct(o['Appointments / Leads'], o.Contacted),
    'Appt/Lead → Close %': pct(o.Sold, o['Appointments / Leads'])
  });

  // UI populate
  function populateSelectors(){
    $('#metric-select').innerHTML = METRICS.map(m=>`<option>${m.label}</option>`).join('');
    $('#metric-select').value = state.metric;
    const names = ['All', ...getAgents().map(a=>a.name)];
    $('#agent-select').innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
    $('#agent-select').value = state.agent;
    $('#range-select').value = state.range;
    $('#chart-select').value = state.chart;
    $('#pipe-view').value = state.pipeView;
    $('#agent-pill-name').textContent = state.agent;
  }

  // header + KPIs
  function renderHeaderKPIs(){
    $('#company').textContent = DATA.company || 'Performance';
    const date = new Date(DATA.generatedAtUTC || Date.now());
    $('#last-updated').textContent = date.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});

    const base = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent) || {Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
    const d = addDerived(base);
    $('#kpi-contacted').textContent = fmt(base.Contacted);
    $('#kpi-replies').textContent = fmt(base.Replies);
    $('#kpi-leads').textContent = fmt(base['Appointments / Leads']);
    $('#kpi-sold').textContent = fmt(base.Sold);
    $('#kpi-replyPct').textContent = nicePct(d['Reply %']);
    $('#kpi-c2l').textContent = nicePct(d['Contacted → Appt/Lead %']);
    $('#kpi-l2c').textContent = nicePct(d['Appt/Lead → Close %']);
  }

  // main chart
  function renderMainChart(){
    const agents = getAgents().map(addDerived);
    const selectedMetric = METRICS.find(m=>m.label===state.metric);

    // choose data by agent scope
    let cats=[], series=[], dataVals=[];
    if(state.agent==='All'){
      cats = agents.map(a=>a.name);
      dataVals = agents.map(a=>a[selectedMetric.key]||0);
    }else{
      const a = agents.find(x=>x.name===state.agent) || null;
      cats = ['Contacted','Replies','Appt/Leads','Sold'];
      dataVals = a ? [a.Contacted,a.Replies,a['Appointments / Leads'],a.Sold] : [0,0,0,0];
    }

    const yFmt = (v)=> selectedMetric?.pct ? `${Math.round(v)}%` : fmt(v);

    // fallback: if Line selected but <2 points, force Funnel
    const usableType = (state.chart==='line' && (dataVals.filter(v=>v>0).length<2 || cats.length<2)) ? 'funnel' : state.chart;

    const opts = { series:[], colors:['#ed6c03','#22c55e','#f59e0b','#ef4444'], chart:{ toolbar:{show:false}, parentHeightOffset:0 },
      dataLabels:{enabled:false}, grid:{borderColor:getComputedStyle(document.documentElement).getPropertyValue('--line').trim(), strokeDashArray:4},
      tooltip:{theme:'dark'} };

    if(usableType==='funnel'){
      const b = (state.agent==='All') ? totalsOf(getAgents()) : (getAgents().find(a=>a.name===state.agent)||{Contacted:0,Replies:0,'Appointments / Leads':0,Sold:0});
      const seriesData = [
        {x:'Contacted', y:b.Contacted},
        {x:'Replies', y:b.Replies, goals:[{ name:'step', value:b.Replies, strokeColor:'#22c55e'}]},
        {x:'ApptLeads', y:b['Appointments / Leads'], goals:[{value:b['Appointments / Leads'], strokeColor:'#f59e0b'}]},
        {x:'Sold', y:b.Sold, goals:[{value:b.Sold, strokeColor:'#ef4444'}]}
      ];
      opts.chart.type = 'bar';
      opts.plotOptions = {bar:{horizontal:true, borderRadius:6, barHeight:'40%'}};
      opts.xaxis = {labels:{style:{colors:'#a9b0bc'}}};
      opts.series = [{ name:'', data:seriesData }];
    } else if(usableType==='donut'){
      opts.chart.type='donut';
      opts.labels = cats;
      opts.series = dataVals.map(v=>Math.max(0, Number(v)||0));
      opts.legend = {position:'right', labels:{colors:'#a9b0bc'}};
    } else if(usableType==='bar-h'){
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:true, borderRadius:6}};
      opts.xaxis={categories:cats, labels:{style:{colors:'#a9b0bc'}}};
      opts.series=[{name:selectedMetric.label, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else if(usableType==='bar'){
      opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:false, borderRadius:6, columnWidth:'55%'}};
      opts.xaxis={categories:cats, labels:{style:{colors:'#a9b0bc'}}};
      opts.series=[{name:selectedMetric.label, data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    } else { // line
      opts.chart.type='line'; opts.stroke={curve:'smooth', width:3}; opts.markers={size:3};
      opts.xaxis={categories:cats, labels:{style:{colors:'#a9b0bc'}}};
      opts.yaxis={labels:{style:{colors:'#a9b0bc'}, formatter:yFmt}};
      opts.series=[{name:(state.agent==='All'?selectedMetric.label:state.agent), data:dataVals.map(v=>Math.max(0, Number(v)||0))}];
    }

    if(mainChart) mainChart.destroy();
    mainChart = new ApexCharts($('#main-chart'), {...opts, chart:{...opts.chart, height:380}});
    mainChart.render();
  }

  // pipeline
  function getPipeTotals(){
    if(state.agent==='All') return (DATA.auditStatusTotals||[]);
    const agentBlock = (DATA.auditByAgent||[]).find(a=>a.agent===state.agent);
    return agentBlock ? agentBlock.totals || [] : [];
  }

  function renderPipeline(){
    const rows = getPipeTotals();
    const total = rows.reduce((s,r)=>s+(r.Count||0),0);
    $('#pipe-title').textContent = `Pipeline Status${state.agent==='All'?'':` — ${state.agent}`}`;
    $('#pipe-total').textContent = `Total Contacts: ${fmt(total)}`;

    const view = state.pipeView;
    $('#pipeline-table').style.display = view==='table'? 'block':'none';
    $('#pipeline-chart').style.display = view==='table'? 'none':'block';

    if(view==='table'){
      const html = rows.map(r=>{
        const p = pct(r.Count||0, total);
        const color = COLORS[r.Status] || COLORS.default;
        return `<div class="pipe-row">
          <div><span class="dot" style="background:${color}"></span>${r.Status}</div>
          <div style="text-align:right">${fmt(r.Count)} (${p.toFixed(1)}%)</div>
          <div class="bar"><span style="width:${p}%; background:${color}"></span></div>
        </div>`;
      }).join('');
      $('#pipeline-table').innerHTML = html || '<div class="hint">No data.</div>';
    } else {
      const series = rows.map(r=>Math.max(0,(r.Count||0)));
      const labels = rows.map(r=>r.Status);
      const colors = rows.map(r=>COLORS[r.Status]||COLORS.default);
      const opts = { chart:{toolbar:{show:false}, parentHeightOffset:0}, labels, colors, tooltip:{theme:'dark'}, legend:{labels:{colors:'#a9b0bc'}} };
      if(view==='bars'){
        opts.chart.type='bar'; opts.plotOptions={bar:{horizontal:true, borderRadius:6}};
        opts.xaxis={categories:labels, labels:{style:{colors:'#a9b0bc'}}};
        opts.series=[{name:'Count', data:series}];
      } else { // donut
        opts.chart.type='donut'; opts.series=series;
      }
      if(pipeChart) pipeChart.destroy();
      pipeChart = new ApexCharts($('#pipeline-chart'), {...opts, chart:{...opts.chart, height:360}});
      pipeChart.render();
    }
  }

  // loader controls
  const showLoader = (flag)=>{ $('#loader').style.display = flag? 'grid':'none'; };

  // events
  function wire(){
    $('#range-select').addEventListener('change', e=>{ state.range=e.target.value; refreshAll(); });
    $('#metric-select').addEventListener('change', e=>{ state.metric=e.target.value; refreshChartsOnly(); });
    $('#agent-select').addEventListener('change', e=>{ state.agent=e.target.value; $('#agent-pill-name').textContent = state.agent; refreshAll(); });
    $('#chart-select').addEventListener('change', e=>{ state.chart=e.target.value; renderMainChart(); sendHeight(); });
    $('#pipe-view').addEventListener('change', e=>{ state.pipeView=e.target.value; renderPipeline(); sendHeight(); });
    $('#show-all').addEventListener('click', ()=>{ state.agent='All'; $('#agent-select').value='All'; $('#agent-pill-name').textContent='All'; refreshAll(); });
    window.addEventListener('resize', ()=> sendHeight());
    window.addEventListener('message', (e)=>{ const m=e?.data; if(m&&m.type==='VQ_METRICS'){ renderDashboard(m.payload); }});
  }

  function refreshAll(){ renderHeaderKPIs(); renderMainChart(); renderPipeline(); sendHeight(); }
  function refreshChartsOnly(){ renderMainChart(); renderPipeline(); sendHeight(); }

  function sendHeight(){ setTimeout(()=>{ parent.postMessage({type:'VQ_IFR_HEIGHT', height: document.body.scrollHeight }, '*'); }, 0); }

  // public entry
  window.renderDashboard = function(payload){
    try{
      showLoader(true);
      DATA = (typeof payload==='string')? JSON.parse(payload||'{}') : (payload||{});
      // defaults
      state.range = '24h'; // requested default
      state.chart = 'funnel';
      state.metric = state.metric || 'Reply %';
      state.agent = 'All';
      populateSelectors();
      refreshAll();
    }catch(err){ console.error('renderDashboard failed', err); }
    finally{ showLoader(false); }
  };

  // init shell before data
  document.addEventListener('DOMContentLoaded', ()=>{ populateSelectors(); wire(); sendHeight(); });
})();
</script>
</body>
</html>
